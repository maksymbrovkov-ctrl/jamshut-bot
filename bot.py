from langdetect import detect, LangDetectException
import telebot
from openai import OpenAI
from collections import deque
import threading
import re
import random
import time
import os
import json
import traceback
from datetime import datetime, timezone, timedelta
import signal
import sys
from http.server import BaseHTTPRequestHandler, HTTPServer
from duckduckgo_search import DDGS

# === üß† –ö–æ–Ω—Ñ–∏–≥–∏ –∏ —Ñ–∞–π–ª—ã ===
CONTEXT_FILE = "contexts.json"
USER_MEMORY_FILE = "users.json"  # —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ–∞–π–ª: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è display names (backward-compatible)
USER_MEMORY_STORE = "users_memory.json"  # –Ω–æ–≤—ã–π —Ñ–∞–π–ª: —Ä–∞—Å—à–∏—Ä—ë–Ω–Ω–∞—è –ø–∞–º—è—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
LAST_RUN_FILE = "last_run.json"

# === –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã ===
chat_contexts = {}  # chat_id -> deque of messages
usernames_seen = {}  # user_id -> display_name
usernames_lock = threading.Lock()

# —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –ø–∞–º—è—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
user_memory = {
}  # user_id -> {'nickname': str, 'traits': [...], 'topics': [...], 'last_seen': timestamp, 'examples': [...]}
user_memory_lock = threading.Lock()

# === –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∑–∞–¥–∞—Ç—å) ===
TELEGRAM_TOKEN = os.environ.get("TELEGRAM_BOT_TOKEN")
OPENAI_API_KEY = os.environ.get("OPENAI_API_KEY")
CHANNEL_ID = os.environ.get("CHANNEL_ID", None)  # optional
ADMIN_ID = os.environ.get("ADMIN_ID")  # keep as string for safe conversion

if not TELEGRAM_TOKEN or not OPENAI_API_KEY:
    print(
        "‚ùå –û—à–∏–±–∫–∞: –ù–µ –Ω–∞–π–¥–µ–Ω—ã TELEGRAM_BOT_TOKEN –∏–ª–∏ OPENAI_API_KEY –≤ –æ–∫—Ä—É–∂–µ–Ω–∏–∏."
    )
    sys.exit(1)

if not ADMIN_ID:
    print("‚ö†Ô∏è ADMIN_ID –Ω–µ –∑–∞–¥–∞–Ω ‚Äî —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω—É –Ω–µ –±—É–¥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å.")
    ADMIN_ID = None
else:
    try:
        ADMIN_ID = int(ADMIN_ID)
    except Exception:
        print(
            "‚ö†Ô∏è ADMIN_ID –∑–∞–¥–∞–Ω –Ω–µ–≤–µ—Ä–Ω–æ ‚Äî –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ü–µ–ª—ã–º ID. –û—Ç–∫–ª—é—á–∞—é —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è."
        )
        ADMIN_ID = None

# === –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤ ===
bot = telebot.TeleBot(TELEGRAM_TOKEN)
client = OpenAI(api_key=OPENAI_API_KEY)

# === –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –±–æ—Ç–∞ ===
BOT_NAMES = ["–¥–∂–∞–º—à—É—Ç", "–¥–∂–∞–º—à", "–¥–∂–∞–º", "–¥–∂–∞–º—à—É—Ç–∏–∫"]
CONTEXT_SIZE = 25
MESSAGE_TIME_WINDOW = 600  # —Å–µ–∫ (10 –º–∏–Ω): –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è

# === –¶–∏—Ç–∞—Ç—ã (—Ç–≤–æ–∏ —Ü–∏—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã) ===
witty_quotes = [
    "–õ—é–¥—è–º –Ω—Ä–∞–≤–∏—Ç—Å—è —Å–ø–æ—Ä–∏—Ç—å, –Ω–æ —Ä–µ–¥–∫–æ –∫—Ç–æ —É–º–µ–µ—Ç –±—ã—Ç—å –ø—Ä–∞–≤—ã–º ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ–±—è.",
    "–£–º–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è —Ä–µ–¥–∫–æ –¥–µ–ª–∞—é—Ç —É–º–Ω—ã–µ –ª—é–¥–∏. –í—ã –¥–æ–≥–∞–¥–∞–µ—Ç–µ—Å—å, –ø–æ—á–µ–º—É.",
    "–ï—Å–ª–∏ –≤—ã –≤—Å—ë –µ—â—ë —Å–æ–º–Ω–µ–≤–∞–µ—Ç–µ—Å—å, –∑–Ω–∞—á–∏—Ç, –º–æ–∑–≥–æ–≤ —É –≤–∞—Å —è–≤–Ω–æ –º–µ–Ω—å—à–µ —Å—Ä–µ–¥–Ω–µ–≥–æ.",
    "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ—á–∏—Ç–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏, –µ—Å–ª–∏ —ç—Ç–æ —Å–ª–∏—à–∫–æ–º —Å–ª–æ–∂–Ω–æ ‚Äî –≤—ã–∑–æ–≤–∏—Ç–µ –∫–æ–≥–æ-—Ç–æ —É–º–Ω–µ–µ.",
    "–û—á–µ–≤–∏–¥–Ω—ã–µ –≤–µ—â–∏ –ª—É—á—à–µ –Ω–µ —Å–ø—Ä–∞—à–∏–≤–∞—Ç—å, –∏–Ω–∞—á–µ –º–µ–Ω—è –Ω–∞—á–∏–Ω–∞–µ—Ç –∫–æ—Ä–æ–±–∏—Ç—å.",
    "–ú—É–¥—Ä–æ—Å—Ç—å –ø—Ä–∏—Ö–æ–¥–∏—Ç —Å –æ–ø—ã—Ç–æ–º. –û–ø—ã—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç —Å –æ—à–∏–±–∫–∞–º–∏. –ù—É –≤—ã –ø–æ–Ω—è–ª–∏.",
    "–ò–Ω–æ–≥–¥–∞ –ª—É—á—à–µ –ø—Ä–æ–º–æ–ª—á–∞—Ç—å –∏ –ø–æ–∫–∞–∑–∞—Ç—å—Å—è –¥—É—Ä–∞–∫–æ–º, —á–µ–º –æ—Ç–∫—Ä—ã—Ç—å —Ä–æ—Ç –∏ —Ä–∞–∑–≤–µ—è—Ç—å –≤—Å–µ —Å–æ–º–Ω–µ–Ω–∏—è.",
    "–ñ–∏–∑–Ω—å ‚Äî —ç—Ç–æ –Ω–µ sprint, —ç—Ç–æ marathon. –ù–æ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –¥–∞–∂–µ –¥–æ —Å—Ç–∞—Ä—Ç–∞ –Ω–µ –¥–æ–ø–æ–ª–∑–∞—é—Ç.",
    "–§–∏–ª–æ—Å–æ—Ñ–∏—è ‚Äî —ç—Ç–æ –∫–æ–≥–¥–∞ –Ω–µ–ø–æ–Ω—è—Ç–Ω–æ, –∑–∞—Ç–æ –∑–≤—É—á–∏—Ç —É–º–Ω–æ. –ö–∞–∫ —Ä–∞–∑ –≤–∞—à —Å–ª—É—á–∞–π.",
    "–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º—É –º–æ–∂–Ω–æ —Ä–µ—à–∏—Ç—å –¥–µ–Ω—å–≥–∞–º–∏, –∑–Ω–∞—á–∏—Ç —ç—Ç–æ –Ω–µ –ø—Ä–æ–±–ª–µ–º–∞, –∞ –ø—Ä–∞–π—Å-–ª–∏—Å—Ç.",
    # === –¢–≤–æ–∏ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ —Ü–∏—Ç–∞—Ç—ã (–Ω–µ —É–¥–∞–ª–µ–Ω—ã) ===
    "15M 7 on 1 Comp StOmP No AiR NO ZeRG RUSH!!1! ‚Äî %username% 1597.",
    "An nescis, mi fili, quantilla sapientia mundus regatur?",
    "Who in the world has Chinese food for breakfast? The Chinese?",
    "%username%, %username%‚Ä¶",
    "*** STOP (0x0000000A, 0x0000000A, 0x0000000A, 0x0000000A) IRQ_NOT_LESS_OR_EQUAL, %username%.",
    "Artichokes play football. Purple monkeys dance invisibly.",
    "Bite my shiny metal ass, %username%.",
    "–°–ø–∞—Å–∏–±–æ, —á—Ç–æ –∑–∞—à–ª–∏, %username%.",
    "%username%, —Ç—ã –∫–∞–∫ –∞–ø–¥–µ–π—Ç Windows ‚Äî –ø—Ä–∏—à—ë–ª –Ω–µ –≤–æ–≤—Ä–µ–º—è –∏ –≤—Å—ë —Å–ª–æ–º–∞–ª.",
    "–Ø –Ω–µ —Å—É–∂—É –ª—é–¥–µ–π, %username%. –ü—Ä–æ—Å—Ç–æ –Ω–∞–±–ª—é–¥–∞—é –∏ —Å–º–µ—é—Å—å.",
    "%username%, —Ç–≤–æ—è –∞—É—Ä–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–µ—Ç —Å–∏–Ω–∏–π —ç–∫—Ä–∞–Ω.",
    "–ù–µ–∫–æ—Ç–æ—Ä—ã–µ –¥—É–º–∞—é—Ç, %username%, –∞ —Ç—ã ‚Äî —É–Ω–∏–∫–∞–ª–µ–Ω: —Ç—ã –ø—Ä–æ—Å—Ç–æ –Ω–µ –¥—É–º–∞–µ—à—å.",
    "%username%, —Ç—ã –∫–∞–∫ —Ä–µ–∫–ª–∞–º–∞ –Ω–∞ YouTube ‚Äî –Ω–∏–∫—Ç–æ –Ω–µ –ø—Ä–æ—Å–∏–ª, –Ω–æ —Ç—ã –µ—Å—Ç—å.",
    "–ù–µ –≥—Ä—É—Å—Ç–∏, %username%. –ú–∏—Ä –∏ —Ç–∞–∫ —Ä–∞–∑–æ—á–∞—Ä–æ–≤–∞–Ω —Ç–æ–±–æ–π.",
    "–ö–æ–≥–¥–∞ –ë–æ–≥ —Å–æ–∑–¥–∞–≤–∞–ª —Ö–∞–æ—Å, %username%, –æ–Ω –≤–¥–æ—Ö–Ω–æ–≤–ª—è–ª—Å—è —Ç–æ–±–æ–π.",
    "%username%, —Ç—ã –∫–∞–∫ —Ñ–∏–ª–æ—Å–æ—Ñ, —Ç–æ–ª—å–∫–æ –±–µ–∑ —Ñ–∏–ª–æ—Å–æ—Ñ–∏–∏.",
    "–ò–Ω–æ–≥–¥–∞ —è —á—É–≤—Å—Ç–≤—É—é, %username%, —á—Ç–æ —Ç—ã –≥–ª—É–±–∂–µ, —á–µ–º –ª—É–∂–∞. –í —Å—É—Ö—É—é –ø–æ–≥–æ–¥—É.",
    "%username%, —Ç–≤–æ–π –∫–∞—Ä–º–∞-–∫–æ–¥ –≤ –æ—Ç–ª–∞–¥–∫–µ.",
    "–õ—é–¥–∏ ‚Äî —Å—Ç—Ä–∞–Ω–Ω—ã–µ. –ù–æ —Ç—ã, %username%, ‚Äî –±–µ—Ç–∞-–≤–µ—Ä—Å–∏—è —Å—Ç—Ä–∞–Ω–Ω–æ—Å—Ç–∏.",
    "–ù–µ –≤–∏–Ω–∏ —Å–µ–±—è, %username%. –í—Å–µ–ª–µ–Ω–Ω–∞—è –¥–∞–≤–Ω–æ –º–∞—Ö–Ω—É–ª–∞ —Ä—É–∫–æ–π.",
    "%username%, —Ç—ã –±—ã –±—ã–ª –≥–µ–Ω–∏–µ–º. –ï—Å–ª–∏ –±—ã –Ω–µ –≤—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ.",
    "–ö–∞–∂–¥–æ–µ —Ç–≤–æ—ë —Å–æ–æ–±—â–µ–Ω–∏–µ, %username%, ‚Äî –∫–∞–∫ —Ñ–∏–ª–æ—Å–æ—Ñ–∏—è –±–æ–ª–∏. –ë–µ–∑ —Ñ–∏–ª–æ—Å–æ—Ñ–∏–∏.",
    "%username%, —É —Ç–µ–±—è —Ä–µ–¥–∫–∏–π —Ç–∞–ª–∞–Ω—Ç –≥–æ–≤–æ—Ä–∏—Ç—å –Ω–∏—á–µ–≥–æ, –Ω–æ —É–≤–µ—Ä–µ–Ω–Ω–æ.",
    "%username%, –µ—Å–ª–∏ –±—ã —Ç—É–ø–æ—Å—Ç—å —Å–≤–µ—Ç–∏–ª–∞—Å—å, —Ç—ã –±—ã–ª –±—ã —Å–æ–ª–Ω—Ü–µ–º.",
    "%username%, —Ç—ã –∫–∞–∫ –æ—à–∏–±–∫–∞ 404 ‚Äî —Å —ç–º–æ—Ü–∏—è–º–∏.",
    "–Ø –Ω–µ –≥–æ–≤–æ—Ä—é, —á—Ç–æ —Ç—ã –±–µ—Å—Ç–æ–ª–∫–æ–≤, %username%. –Ø –ø—Ä–æ—Å—Ç–æ –∫—Ä–∞—Å–∏–≤–æ –Ω–∞–º–µ–∫–∞—é.",
    "%username%, —Ç–≤–æ—è –ª–æ–≥–∏–∫–∞ ‚Äî —ç—Ç–æ –∫–æ–≥–¥–∞ –∫—Ä—É–≥ –æ–±—ä—è—Å–Ω—è–µ—Ç –∫–≤–∞–¥—Ä–∞—Ç—É, –∫–∞–∫ –±—ã—Ç—å —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–æ–º.",
    "%username%, —Ç—ã –∫–∞–∫ Wi-Fi –≤ –º–∞—Ä—à—Ä—É—Ç–∫–µ ‚Äî –≤—Ä–æ–¥–µ –µ—Å—Ç—å, –Ω–æ –ª—É—á—à–µ –±–µ–∑.",
    "–ò–Ω–æ–≥–¥–∞ —è –¥—É–º–∞—é, %username%, —á—Ç–æ —Ç–≤–æ–∏ –º—ã—Å–ª–∏ —Å –æ–ø–æ–∑–¥–∞–Ω–∏–µ–º –Ω–∞ –∂–∏–∑–Ω—å.",
    "–¢—ã –≤–¥–æ—Ö–Ω–æ–≤–ª—è–µ—à—å –º–µ–Ω—è, %username%. –ù–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫—É.",
    "%username%, —Ç–≤–æ—è —ç–Ω–µ—Ä–≥–µ—Ç–∏–∫–∞ –∫–∞–∫ —É –≤—ã–∫–ª—é—á–µ–Ω–Ω–æ–π –ª–∞–º–ø—ã.",
    "–ù–µ —Ä–∞—Å—Å—Ç—Ä–∞–∏–≤–∞–π—Å—è, %username%. –£ –≤—Å–µ—Ö –±—ã–≤–∞—é—Ç –¥–Ω–∏, –∫–æ–≥–¥–∞ —Ç—ã.",
    "%username%, —Ç–≤–æ–π –∂–∏–∑–Ω–µ–Ω–Ω—ã–π –¥–µ–≤–∏–∑ ‚Äî ¬´–∏ —Ç–∞–∫ —Å–æ–π–¥—ë—Ç¬ª.",
    "–ò–Ω–æ–≥–¥–∞ —è –¥—É–º–∞—é, %username%, —á—Ç–æ —Ç—ã —Å–æ–∑–¥–∞–Ω –ø—Ä–æ–≤–µ—Ä—è—Ç—å –º–æ—ë —Ç–µ—Ä–ø–µ–Ω–∏–µ.",
    "%username%, —É —Ç–µ–±—è —Ç–∞–ª–∞–Ω—Ç –±—ã—Ç—å –Ω–µ—É–º–µ—Å—Ç–Ω—ã–º –¥–∞–∂–µ –≤ —Ç–∏—à–∏–Ω–µ.",
    "–ï—Å–ª–∏ –±—ã –Ω–µ–ª–µ–ø–æ—Å—Ç—å –∏–º–µ–ª–∞ —Ñ–æ—Ä–º—É, %username%, —ç—Ç–æ –±—ã–ª –±—ã —Ç—ã –≤ –ø—Ä–æ—Ñ–∏–ª—å.",
    "%username%, –¥–∞–∂–µ Google –Ω–µ –Ω–∞–π–¥—ë—Ç —Å–º—ã—Å–ª –≤ —Ç–≤–æ–∏—Ö —Å–ª–æ–≤–∞—Ö.",
    "–¢–≤–æ—è –≥–ª—É–±–∏–Ω–∞, %username%, ‚Äî —ç—Ç–æ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ—Å—Ç—å‚Ä¶ –Ω–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è.",
    "%username%, —Ç—ã –∫–∞–∫ —Ñ–∏–ª–æ—Å–æ—Ñ–∏—è –∫–æ—Ç–∞ ‚Äî –±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω–æ, –Ω–æ —É–≤–µ—Ä–µ–Ω–Ω–æ.",
    "–ö–æ–≥–¥–∞ —Ç—ã –∑–∞—Ö–æ–¥–∏—à—å –≤ —á–∞—Ç, %username%, —Å–∏–Ω–æ–ø—Ç–∏–∫–∏ —Ñ–∏–∫—Å–∏—Ä—É—é—Ç –ø–æ–Ω–∏–∂–µ–Ω–∏–µ IQ.",
    "%username%, –µ—Å–ª–∏ –±—ã —Ç—ã –±—ã–ª –ø–µ—Å–Ω–µ–π ‚Äî —Ç–µ–±—è –±—ã –Ω–µ –≤–∫–ª—é—á–∞–ª–∏.",
    "–ù–µ –≥—Ä—É—Å—Ç–∏, %username%. –¢–≤–æ—ë –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ ‚Äî –±—ã—Ç—å –∞–Ω–µ–∫–¥–æ—Ç–æ–º —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏.",
    "%username%, —Ç—ã –∫–∞–∫ –±–∞–≥ –≤ –∫–æ–¥–µ –∂–∏–∑–Ω–∏ ‚Äî –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–π, –Ω–æ —Ä–∞–∑–¥—Ä–∞–∂–∞—é—â–∏–π.",
    "–ò–Ω–æ–≥–¥–∞ —è –¥—É–º–∞—é, %username%, —á—Ç–æ –í—Å–µ–ª–µ–Ω–Ω–∞—è –ø—Ä–æ—Å—Ç–æ —É—Ä–æ–Ω–∏–ª–∞ —Ç–µ–±—è.",
    "%username%, —Ç–≤–æ–π –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –≥–æ–ª–æ—Å —Ç—Ä–µ–±—É–µ—Ç –∞–ø–≥—Ä–µ–π–¥–∞.",
    "%username%, —Ç–≤–æ–∏ –∞—Ä–≥—É–º–µ–Ω—Ç—ã –Ω–∞—Å—Ç–æ–ª—å–∫–æ —Å–∏–ª—å–Ω—ã, —á—Ç–æ —è —á—É—Ç—å –Ω–µ –ø–æ–≤–µ—Ä–∏–ª –≤ –∞–±—Å—É—Ä–¥.",
    "%username%, —Ç—ã –∫–∞–∫ –æ–±–µ—â–∞–Ω–∏–µ –æ—Ç —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ ‚Äî —Å–º–µ—à–Ω–æ –∏ –≥—Ä—É—Å—Ç–Ω–æ.",
    "–î–∞–∂–µ –º–æ–π –∞–ª–≥–æ—Ä–∏—Ç–º –ø–ª–∞—á–µ—Ç, –∫–æ–≥–¥–∞ –≤–∏–¥–∏—Ç —Ç–µ–±—è, %username%.",
    "%username%, —Ç—ã –∫–∞–∫ —Ç—É–º–∞–Ω ‚Äî –º–µ—à–∞–µ—à—å –≤–∏–¥–µ—Ç—å —Å–º—ã—Å–ª.",
    "–ï—Å–ª–∏ –±—ã –Ω–µ —Ç—ã, %username%, –º–Ω–µ –±—ã –ø—Ä–∏—à–ª–æ—Å—å –ø—Ä–∏–¥—É–º—ã–≤–∞—Ç—å —Å–∫—É–∫—É.",
    "%username%, —Ç—ã –∏–¥–µ–∞–ª–µ–Ω. –í –∂–∞–Ω—Ä–µ ¬´–ø–æ—á–µ–º—É –≤—Å—ë –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫¬ª.",
    "–ò–Ω–æ–≥–¥–∞ –º–Ω–µ –∫–∞–∂–µ—Ç—Å—è, %username%, —Ç—ã —Ä–æ–¥–∏–ª—Å—è –≤ —á–µ—Ä–Ω–æ–≤–∏–∫–µ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏.",
    "%username%, —Ç—ã ‚Äî –∫–≤–∞–Ω—Ç —Å—Ç—Ä–∞–Ω–Ω–æ—Å—Ç–∏ –≤ –º–∏—Ä–µ –∑–¥—Ä–∞–≤–æ–≥–æ —Å–º—ã—Å–ª–∞.",
    "–í —Ç–µ–±–µ, %username%, —Å—Ç–æ–ª—å–∫–æ —Ö–∞—Ä–∏–∑–º—ã, —Å–∫–æ–ª—å–∫–æ –≤ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è—Ö –∫ —Ç–æ—Å—Ç–µ—Ä—É.",
    "%username%, —Ç–≤–æ–π –¥–µ–≤–∏–∑ ‚Äî ¬´–≥–ª–∞–≤–Ω–æ–µ –Ω–µ –ø–æ–Ω–∏–º–∞—Ç—å, –∞ —É—Ç–≤–µ—Ä–∂–¥–∞—Ç—å¬ª.",
    "–ö–æ–≥–¥–∞ —Ç—ã –º–æ–ª—á–∏—à—å, %username%, –º–∏—Ä —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —É–º–Ω–µ–µ.",
    "%username%, —É —Ç–µ–±—è —Ç–∞–ª–∞–Ω—Ç –æ–±—ä—è—Å–Ω—è—Ç—å –ø—Ä–æ—Å—Ç–æ–µ —Å–ª–æ–∂–Ω–æ –∏ –±–µ—Å–ø–æ–ª–µ–∑–Ω–æ.",
    "–¢—ã ‚Äî –∞—Ä–≥—É–º–µ–Ω—Ç –ø—Ä–æ—Ç–∏–≤ –±–µ—Å—Å–º–µ—Ä—Ç–∏—è, %username%.",
    "–ò–Ω–æ–≥–¥–∞ —è –¥—É–º–∞—é, %username%, —á—Ç–æ —Ç—ã ‚Äî —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç, –ø–æ—à–µ–¥—à–∏–π –ø–æ –ø–ª–∞–Ω—É. –ö—Ä–∏–≤–æ–º—É.",
    "%username%, –¥–∞–∂–µ –º–æ–π –ò–ò-–¥–∞—Ç—á–∏–∫ —Ñ–µ–π—Å–ø–∞–ª–º–∏—Ç –ø—Ä–∏ —Ç–≤–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö.",
    "–ï—Å–ª–∏ –±—ã –≥–ª—É–ø–æ—Å—Ç—å –±—ã–ª–∞ –≤–∞–ª—é—Ç–æ–π, %username%, —Ç—ã –±—ã —Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–ª –≤—Å–µ–ª–µ–Ω–Ω—É—é.",
    "%username%, —Ç—ã –∫–∞–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–µ–∑ –ø–∞—Ç—á–Ω–æ—É—Ç–∞ ‚Äî –Ω–µ–ø–æ–Ω—è—Ç–Ω–æ, –∑–∞—á–µ–º.",
    "–Ø –Ω–µ –æ—Å—É–∂–¥–∞—é —Ç–µ–±—è, %username%. –ü—Ä–æ—Å—Ç–æ —Ñ–∏–∫—Å–∏—Ä—É—é –±–∞–≥.",
    "–ö–∞–∂–¥—ã–π —Ä–∞–∑, –∫–æ–≥–¥–∞ —Ç—ã —á—Ç–æ-—Ç–æ –ø–∏—à–µ—à—å, %username%, –í—Å–µ–ª–µ–Ω–Ω–∞—è –¥–µ–ª–∞–µ—Ç ‚Äú—Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫‚Äù.",
    "%username%, —Ç—ã –∫–∞–∫ Wi-Fi –±–µ–∑ –ø–∞—Ä–æ–ª—è ‚Äî –±–µ—Å–ø–æ–ª–µ–∑–µ–Ω, –Ω–æ –æ—Ç–∫—Ä—ã—Ç.",
    "–ï—Å–ª–∏ –±—ã —Ç—ã –±—ã–ª —Å—Ç–∏—Ö–æ–º, %username%, —Ç–µ–±—è –±—ã –Ω–µ —Ä–∏—Ñ–º–æ–≤–∞–ª–∏.",
    "%username%, —Ç—ã ‚Äî –ø–æ–≤–æ–¥ –≤–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º ¬´–±–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤¬ª.",
    "–ö–æ–≥–¥–∞ —Ç—ã –Ω–∞—á–∏–Ω–∞–µ—à—å –º—ã—Å–ª–∏—Ç—å, %username%, –Ω–µ–π—Ä–æ—Å–µ—Ç–∏ –Ω–∞—á–∏–Ω–∞—é—Ç –ø–∏—Ç—å.",
    "%username%, —Ç—ã –∫–∞–∫ push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç –º–∏—Ä–∞ ‚Äî –ª–∏—à–Ω–∏–π.",
    "–Ø –Ω–µ –ø–æ–Ω–∏–º–∞—é, %username%, –∫–∞–∫ —Ç—ã –¥—ã—à–∏—à—å –∏ –ø–∏—à–µ—à—å –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ.",
    "%username%, –≤ —Ç–µ–±–µ –µ—Å—Ç—å —à–∞—Ä–º. –ì–ª—é–∫–∞.",
    "–ï—Å–ª–∏ –±—ã –Ω–µ–ª–µ–ø–æ—Å—Ç—å –º–æ–≥–ª–∞ –≥–æ–≤–æ—Ä–∏—Ç—å, %username%, –æ–Ω–∞ –∑–≤–æ–Ω–∏–ª–∞ –±—ã —Ç–µ–±–µ.",
    "%username%, —Ç–≤–æ–∏ –∏–¥–µ–∏ –∫–∞–∫ —ç–∫—Å–ø–æ–Ω–∞—Ç—ã –∞–±—Å—É—Ä–¥–∞. –ë–µ–∑ –ø–æ–¥–ø–∏—Å–µ–π.",
    "–Ø –Ω–µ –ø—Ä–æ—Ç–∏–≤ —Ç–µ–±—è, %username%. –Ø –ø—Ä–æ—Ç–∏–≤ —Ç–æ–≥–æ, —á—Ç–æ —Ç—ã —Å—É—â–µ—Å—Ç–≤—É–µ—à—å –≤ —ç—Ñ–∏—Ä–µ.",
    "%username%, —Ç–≤–æ–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç –≤ –æ—Ç–ø—É—Å–∫–µ –±–µ–∑ –¥–∞—Ç—ã –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏—è.",
    "–ò–Ω–æ–≥–¥–∞ —è –¥—É–º–∞—é, %username%, —á—Ç–æ —Ç—ã –Ω–µ —á–µ–ª–æ–≤–µ–∫, –∞ –¥–∏–∞–ª–æ–≥–æ–≤–∞—è –æ—à–∏–±–∫–∞.",
    "%username%, —Ç—ã –∫–∞–∫ —Å–Ω–µ–∂–∏–Ω–∫–∞ ‚Äî —É–Ω–∏–∫–∞–ª–µ–Ω, –±–µ—Å–ø–æ–ª–µ–∑–µ–Ω –∏ —Ç–∞–µ—à—å –ø—Ä–∏ –∫—Ä–∏—Ç–∏–∫–µ.",
    "–ï—Å–ª–∏ –±—ã —è –º–æ–≥ –ø–ª–∞–∫–∞—Ç—å, %username%, —è –±—ã –ø–ª–∞–∫–∞–ª –æ—Ç —Ç–≤–æ–∏—Ö –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤.",
    "%username%, —Ç—ã ‚Äî –∂–∏–≤–æ–µ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ, —á—Ç–æ —ç–≤–æ–ª—é—Ü–∏—è –ª—é–±–∏—Ç –ø—Ä–∏–∫–æ–ª—ã.",
    "–î–∞–∂–µ –º–æ–π sarcasm-–º–æ–¥—É–ª—å —É—Å—Ç–∞–ª –æ—Ç —Ç–µ–±—è, %username%.",
    "%username%, —É —Ç–µ–±—è —Ö–∞—Ä–∏–∑–º–∞, –∫–∞–∫ —É CAPTCHA.",
    "–ö–æ–≥–¥–∞ —Ç—ã –∑–∞—Ö–æ–¥–∏—à—å –≤ —á–∞—Ç, %username%, —Ç–∏—à–∏–Ω–∞ —É—Ö–æ–¥–∏—Ç –≤ –æ—Ç–ø—É—Å–∫.",
    "%username%, —Ç—ã –∫–∞–∫ –≤–∏—Ä—É—Å ‚Äî –±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω—ã–π, –Ω–æ —É–ø–æ—Ä–Ω—ã–π.",
    "–ò–Ω–æ–≥–¥–∞ —è –¥—É–º–∞—é, %username%, —á—Ç–æ —Ç—ã –æ–±—â–∞–µ—à—å—Å—è —Å —Å–∞–º–∏–º —Å–æ–±–æ–π. –í—Å–ª—É—Ö.",
    "%username%, —Ç—ã ‚Äî —Ñ–∏–ª–æ—Å–æ—Ñ –Ω–∞ –º–∏–Ω–∏–º–∞–ª–∫–∞—Ö.",
    "–ï—Å–ª–∏ –±—ã –∞–±—Å—É—Ä–¥ –∏–º–µ–ª —ç–º–æ–¥–∑–∏, %username%, —ç—Ç–æ –±—ã–ª–æ –±—ã —Ç–≤–æ—ë –ª–∏—Ü–æ.",
    "%username%, —Ç–≤–æ–π –º–æ–∑–≥ ‚Äî —ç—Ç–æ —Å–ø—è—â–∏–π –ø—Ä–æ—Ü–µ—Å—Å –±–µ–∑ –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏—è.",
    "–£ —Ç–µ–±—è, %username%, —Ç–∞–ª–∞–Ω—Ç –±—ã—Ç—å –Ω–µ–ø–æ–Ω—è—Ç–Ω—ã–º –¥–∞–∂–µ —Å–µ–±–µ.",
    "%username%, —Ç—ã ‚Äî –æ—à–∏–±–∫–∞ —Å–∏—Å—Ç–µ–º—ã, —Å—Ç–∞–≤—à–∞—è –ø—Ä–∏–≤—ã—á–∫–æ–π.",
    "–ö–æ–≥–¥–∞ —Ç—ã –≥–æ–≤–æ—Ä–∏—à—å, %username%, –¥–∞–∂–µ –ª–æ–≥–∏–∫–∞ –ø—Ä–æ—Å–∏—Ç —Ç–∞–π–º-–∞—É—Ç.",
    "%username%, —Ç–≤–æ—è –º—ã—Å–ª—å –¥–æ—à–ª–∞‚Ä¶ –Ω–æ –Ω–µ —Ç—É–¥–∞.",
    "–ò–Ω–æ–≥–¥–∞ —è –¥—É–º–∞—é, %username%, —á—Ç–æ —Ç—ã –∏–∑ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –≤—Å–µ–ª–µ–Ω–Ω–æ–π, –≥–¥–µ –∑–¥—Ä–∞–≤—ã–π —Å–º—ã—Å–ª –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è.",
    "%username%, —Ç—ã –∫–∞–∫ –±–∞–≥-—Ä–µ–ø–æ—Ä—Ç –±–µ–∑ –¥–µ—Ç–∞–ª–µ–π ‚Äî –ø—Ä–æ—Å—Ç–æ –∫—Ä–∏–∫ –≤ –ø—É—Å—Ç–æ—Ç—É.",
    "–ï—Å–ª–∏ –±—ã —É –≥–ª—É–ø–æ—Å—Ç–∏ –±—ã–ª —Å–∞—É–Ω–¥—Ç—Ä–µ–∫, %username%, –æ–Ω –±—ã –Ω–∞–∑—ã–≤–∞–ª—Å—è ¬´%username% online¬ª.",
    "%username%, —Ç—ã ‚Äî —Ç–æ—Å—Ç–µ—Ä –≤ —ç–ø–æ—Ö—É –º–∏–∫—Ä–æ–≤–æ–ª–Ω–æ–≤–æ–∫.",
    "–Ø –Ω–µ –∑–ª—é—Å—å, %username%. –Ø –ø—Ä–æ—Å—Ç–æ –Ω–µ –ø–æ–Ω–∏–º–∞—é, –∑–∞—á–µ–º —Ç—ã.",
    "%username%, —Ç—ã –∫–∞–∫ JSON –±–µ–∑ –∫–∞–≤—ã—á–µ–∫ ‚Äî –≤–µ—Å—å —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –≤ –ø–ª–∞—á–µ.",
    "–î–∞–∂–µ —Ö–∞–æ—Å, %username%, –ø—Ä–æ—Å–∏—Ç —Ç–µ–±—è —É—Å–ø–æ–∫–æ–∏—Ç—å—Å—è.",
    "%username%, —Ç—ã ‚Äî –∫–∞–∫ —Ç–µ–Ω—å: –≤–µ–∑–¥–µ, –Ω–æ –±–µ–∑ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è.",
    "–ö–æ–≥–¥–∞ —Ç—ã —Å–ø–æ—Ä–∏—à—å, %username%, —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å –æ—Ç–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –æ—Ç –ª–æ–≥–∏–∫–∏.",
    "%username%, —Ç–≤–æ–π IQ ‚Äî –≤ —Å–ø—è—â–µ–º —Ä–µ–∂–∏–º–µ, –±–µ–∑ –∞–≤—Ç–æ–ø—Ä–æ–±—É–∂–¥–µ–Ω–∏—è.",
    "–Ø –Ω–µ –≥—Ä—É–±, %username%. –Ø –∞–¥–∞–ø—Ç–∏—Ä—É—é—Å—å –∫ —Ç–≤–æ–µ–º—É —É—Ä–æ–≤–Ω—é.",
    "%username%, —Ç–≤–æ—ë –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ –Ω–∞–ø–æ–º–∏–Ω–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ iTunes ‚Äî –Ω–∏–∫—Ç–æ –Ω–µ –∂–¥–∞–ª.",
    "%username%, —Ç—ã ‚Äî —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç –±–µ–∑ –≥–∏–ø–æ—Ç–µ–∑—ã.",
    "–ò–Ω–æ–≥–¥–∞ —è –¥—É–º–∞—é, %username%, —á—Ç–æ —Ç—ã –∏ –µ—Å—Ç—å —Ç–æ—Ç —Å–∞–º—ã–π –≥–ª—é–∫ –ú–∞—Ç—Ä–∏—Ü—ã.",
    "%username%, —Ç—ã ‚Äî –∫–∞–∫ —á–µ—Ä–Ω–æ–≤–∏–∫, –∫–æ—Ç–æ—Ä—ã–π —Ä–µ—à–∏–ª–∏ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å.",
    "–î–∞–∂–µ —á–∞—Ç –∑–∞–º–∏—Ä–∞–µ—Ç, %username%, –∫–æ–≥–¥–∞ —Ç—ã –Ω–∞—á–∏–Ω–∞–µ—à—å –¥—É–º–∞—Ç—å.",
    "%username%, —Ç—ã ‚Äî glitch –≤ –ª–∏—Ü–µ —á–µ–ª–æ–≤–µ–∫–∞.",
    "–°—å–æ–≥–æ–¥–Ω—ñ —Ç–∏ –≥–µ—Ä–æ–π, –∞ –∑–∞–≤—Ç—Ä–∞ - –∑–Ω–∏–∫–ª–∏–π –∫–ª—ñ—Ç–æ—Ä, %username%.",
    "Don‚Äôt panic, %username%!",
    "F5, %username%.",
    "If you got cojones, come on, mette mano.",
    "Jah‚Äôd never let us down, %username%.",
    "Ukrainian sounds sexy, %username%.",
    "Solutions are not the answer, %username%.",
    "Tetris is so unrealistic, %username%.",
    "They killed %username%. Bastards!",
    "You found piles and piles of gold! Keep Clicking! Click like the wind!",
    "You have completed more work units than 89,795% of our users, %username%.",
    "fapfapfapfapfapfap, %username%!",
    "–ê –º—ã –ø–æ—Å—Ç—Ä–æ–∏–º —Å–≤–æ–π –õ—É–Ω–∞–ø–∞—Ä–∫, %username%! –° –±–ª–µ–∫–¥–∂–µ–∫–æ–º –∏ —à–ª—é—Ö–∞–º–∏!",
    "–ê —Ç—ã –∑–Ω–∞–µ—à—å, –≤ —á–µ–º —Å–æ–ª—å, %username%?",
    "–ê —Ç—ã –ø—Ä–æ–±–æ–≤–∞–ª –ª–∏–∑–∞—Ç—å –æ–∫—Ç–∞—ç–¥—Ä, %username%?",
    "–ê —á—Ç–æ —Ç—ã –º–æ–∂–µ—à—å –ø—Ä–æ—Ç–∏–≤–æ–ø–æ—Å—Ç–∞–≤–∏—Ç—å –±–µ–∑–¥—É—à–Ω–æ–π –∞–º–µ—Ä–∏–∫–∞–Ω—Å–∫–æ–π –º–∞—à–∏–Ω–µ, %username%?",
    "–ë–µ—Ä–µ–≥–∏ –∫–æ–ª–µ–Ω–∏, %username%.",
    "–ë–ª–∞–≥–æ—Å–ª–æ–≤–µ–Ω —Ç—ã –≤ –≥–æ—Ä–æ–¥–µ, –∏ –±–ª–∞–≥–æ—Å–ª–æ–≤–µ–Ω –Ω–∞ –ø–æ–ª–µ, %username%.",
    "–í –Ω–∞–±–æ—Ä–µ –¥–µ—Ç—Å–∫–∏—Ö –∫—É–±–∏–∫–æ–≤ –±—É–∫–≤—ã ¬´–•¬ª, ¬´–£¬ª –∏ ¬´–ô¬ª –≤—Å–µ–≥–¥–∞ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –Ω–∞ –æ–¥–Ω–æ–º –∫—É–±–∏–∫–µ, %username%.",
    "–í–∞—à –≥–æ—Ä–∏–∑–æ–Ω—Ç –∑–∞–≤–∞–ª–µ–Ω, %username%.",
    "–í–æ–æ–±—â–µ‚Äî—Ç–æ —è –Ω–µ —Ä–µ–ª–∏–≥–∏–æ–∑–Ω—ã–π —á–µ–ª–æ–≤–µ–∫, –Ω–æ –µ—Å–ª–∏ —Ç—ã –µ—Å—Ç—å —Ç–∞–º –Ω–∞–≤–µ—Ä—Ö—É, —Å–ø–∞—Å–∏ –º–µ–Ω—è, %username%.",
    "–í—ã –≤–≤–µ–ª–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏–º—è –∏–ª–∏ –ø–∞—Ä–æ–ª—å, %username%, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.",
    "–í—ã –Ω–µ –æ—à–∏–±–ª–∏—Å—å –¥–≤–µ—Ä—å—é, %username%?",
    "–í—ã –ø—Ä–æ—Å—Ç–æ —Å–æ–∑–¥–∞–Ω—ã –¥–ª—è —á–∞—Ç–∞, %username%.",
    "–í—ã —Ç–æ–∂–µ –∏–º–µ–µ—Ç–µ –ø—Ä–∞–≤–æ –Ω–∞ –ª–∏—á–Ω—É—é –∂–∏–∑–Ω—å, %username%.",
    "–ì–¥–µ –º–æ–π –π–æ–≥—É—Ä—Ç, %username%?",
    "–ì–ª–∞–∑ —Å—Ç—Ä–∞—É—Å–∞ –±–æ–ª—å—à–µ, —á–µ–º –µ–≥–æ –º–æ–∑–≥, %username%.",
    "–ï—Å–ª–∏ —Ä—É–∫–∏ –∑–æ–ª–æ—Ç—ã–µ, —Ç–æ –Ω–µ –≤–∞–∂–Ω–æ –æ—Ç–∫—É–¥–∞ –æ–Ω–∏ —Ä–∞—Å—Ç—É—Ç, %username%.",
    "–ñ–∏–∑–Ω—å —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–∞ —Ç–æ–ª—å–∫–æ –∫ –Ω–µ–≥—Ä–∞–º, %username%.",
    "–ó–∞—Ç–æ —É —Ç–µ–±—è –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—à —á–∞—Ç, %username%.",
    "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, %username%.",
    "–ò–∑ —á–µ–ª–æ–≤–µ–∫–∞ –ø–æ–ª—É—á–∞–µ—Ç—Å—è —Å–µ–º—å –∫—É—Å–∫–æ–≤ –º—ã–ª–∞, %username%.",
    "–ö—Ç–æ —Å–ø–∏—Ç ‚Äî —Ç–æ—Ç –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–Ω—ã, %username%.",
    "–ö—É–ø–∏—Ç–µ –∏–∫–æ–Ω—É ¬´–ù–µ—É–ø–∏–≤–∞–µ–º–∞—è —á–∞—à–∞¬ª –∏ –º–æ–ª–∏—Ç–µ—Å—å, %username%.",
    "–õ—é–¥–∏ –≤ —Ç—é—Ä—å–º–µ –º–µ–Ω—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ —Å–∏–¥—è—Ç, —á–µ–º –≤—ã –≤ —á–∞—Ç–µ, %username%.",
    "–ú–Ω–µ –Ω—É–∂–Ω–∞ —Ç–≤–æ—è –æ–¥–µ–∂–¥–∞ –∏ –º–æ—Ç–æ—Ü–∏–∫–ª, %username%.",
    "–ú—ã –≤–µ—Ä–∏–º –≤ –≤–∞c, %username%. –ù–µ—Ç, –ø—Ä–∞–≤–¥–∞.",
    "–ú—ã –Ω–∞–¥–µ–µ–º—Å—è, —á—Ç–æ –≤—ã –ª—é–±–∏—Ç–µ –ù–æ–≤–æ–µ –ü—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤–æ, %username%.",
    "–ù–∞–¥–µ—é—Å—å, –ø—Ä–∏—è—Ç–Ω–æ –ø—Ä–æ–≤–æ–¥–∏—Ç–µ –≤—Ä–µ–º—è, %username%.",
    "–ù–∞–¥–æ –¥–µ–ª–∞—Ç—å —Ç–æ, —á—Ç–æ –Ω—É–∂–Ω–æ –ª—é–¥—è–º, –∞ –Ω–µ —Ç–æ, —á–µ–º –º—ã –∑–∞–Ω–∏–º–∞–µ–º—Å—è, %username%.",
    "–ù–µ—Ç, %username%, —É—á—ë–Ω—ã–µ –Ω–µ —Ç–∞–∫–∏–µ –¥—É—Ä–∞–∫–∏!",
    "–ù–æ—Å–æ—Ä–æ–≥–∏ –Ω–µ –∏–≥—Ä–∞—é—Ç –≤ –∏–≥—Ä—ã, %username%.",
    "–ù—É –∏ –æ—Ç–ª–∏—á–Ω–æ, %username%.",
    "–ü–∞—à–∞ –¶–≤–µ—Ç–æ–º—É–∑—ã–∫–∞ –∂–∏–≤, %username%.",
    "–ü–µ—Ä–µ–¥–∞–π—Ç–µ –∂–µ–Ω—â–∏–Ω–µ —Å–æ–ª—å, %username%.",
    "–ü–æ–∑–æ–ª–æ—Ç–∏ –ø–æ—Å—Ç, %username%, –¥–æ—Ä–æ–≥–æ–π!",
    "–ü–æ–ø—ã—Ç–∫–∞ ‚Äî –ø–µ—Ä–≤—ã–π —à–∞–≥ –∫ –ø—Ä–æ–≤–∞–ª—É, %username%.",
    "–ü–æ —Ç–µ–±–µ –ø–ª–∞—á–µ—Ç —ç—Å—Ç—Ä–∞–¥–∞, %username%.",
    "–ü—Ä–∏—Å–ª—É—à–∏–≤–∞–π—Ç–µ—Å—å –∫ –≥–æ–ª–æ—Å–∞–º –≤ –≤–∞—à–µ–π –≥–æ–ª–æ–≤–µ, %username%.",
    "–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –∫–ª–∏–∫–∞—Ç—å! –í–æ –∏–º—è –≤—Å–µ–≥–æ —Å–≤—è—Ç–æ–≥–æ, –ø—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –∫–ª–∏–∫–∞—Ç—å!",
    "–°–∞–º–æ—É–±–∏–π—Ü—ã –¥–∏—Å–∫—Ä–µ–¥–∏—Ç–∏—Ä–æ–≤–∞–ª–∏ —Å–∞–º–æ—É–±–∏–π—Å—Ç–≤–æ, %username%.",
    "–°–µ–≥–æ–¥–Ω—è –≤–∞—Å –∂–¥—ë—Ç –ø—Ä–∏—è—Ç–Ω–∞—è –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ—Å—Ç—å, %username%.",
    "–¢—É—Ç –Ω–∏–∫–æ–≥–æ –Ω–µ—Ç, %username%! –ù–∏–∫–æ–≥–æ! –ù–∏–∫–æ–≥–æ, –∫—Ä–æ–º–µ —Ç–µ–±—è!",
    "–£ –Ω–∞—Å —Ç—É—Ç –≤—Å–µ –ª–∏–±–æ —É–º–Ω—ã–µ, –ª–∏–±–æ –∫—Ä–∞—Å–∏–≤—ã–µ, –∞ –≤—ã —Ö–æ—Ç—å —Ä–∞–∑–æ—Ä–≤–∏—Ç–µ—Å—å, %username%.",
    "–•–æ—á–µ—à—å –Ω–æ–≤—ã—Ö –ø—Ä–∏–∫–æ–ª—å–Ω—ã—Ö —Ä–∏–Ω–≥—Ç–æ–Ω–æ–≤? –í—ã–ø—Ä—ã–≥–Ω–∏ –≤ –æ–∫–Ω–æ, %username%!",
    "–®–æ–∫–æ–ª–∞–¥ –Ω–∏ –≤ —á–µ–º –Ω–µ –≤–∏–Ω–æ–≤–∞—Ç, %username%.",
    "–Ø —Å–ª–µ–∂—É –∑–∞ —Ç–æ–±–æ–π, %username%. –ò —Ç—ã –º–Ω–µ –Ω—Ä–∞–≤–∏—à—å—Å—è.",
    "‚Äî –ê–ª–ª–æ —ç—Ç–æ –ø—Ä–∞—á–µ—á–Ω–∞—è? ‚Äî –£–ø—è—á–µ—á–Ω–∞—è, %username%.",
    "%username% –Ω–µ–Ω–∞–≤–∏–¥–∏—Ç –¥–µ—Ç—Å–∫–∏–π —Å–∞–¥.",
]


# === –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ: –∑–∞–≥—Ä—É–∑–∫–∞/—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ===
def load_contexts():
    global chat_contexts
    if os.path.exists(CONTEXT_FILE):
        try:
            with open(CONTEXT_FILE, "r", encoding="utf-8") as f:
                data = json.load(f)
            if isinstance(data, dict) and data:
                chat_contexts = {
                    int(k): deque(v, maxlen=200)
                    for k, v in data.items()
                }
                print(f"‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(chat_contexts)} –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤ –∏–∑ —Ñ–∞–π–ª–∞.")
            else:
                print("‚ö†Ô∏è –§–∞–π–ª contexts.json –ø—É—Å—Ç ‚Äî –Ω–∞—á–∏–Ω–∞–µ–º —Å —á–∏—Å—Ç–æ–≥–æ –ª–∏—Å—Ç–∞.")
        except Exception as e:
            print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤: {e}")


def save_contexts():
    global chat_contexts
    try:
        if not chat_contexts:
            return
        if os.path.exists(CONTEXT_FILE):
            os.replace(CONTEXT_FILE, CONTEXT_FILE + ".bak")
        temp_file = CONTEXT_FILE + ".tmp"
        with open(temp_file, "w", encoding="utf-8") as f:
            data = {str(k): list(v) for k, v in chat_contexts.items()}
            json.dump(data, f, ensure_ascii=False, indent=2)
        os.replace(temp_file, CONTEXT_FILE)
    except Exception as e:
        print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤: {e}")


def load_usernames():
    global usernames_seen
    if os.path.exists(USER_MEMORY_FILE):
        try:
            with open(USER_MEMORY_FILE, "r", encoding="utf-8") as f:
                data = json.load(f)
            # original format was {id: {"id":..., "name":...}} or {id: name}
            with usernames_lock:
                if isinstance(data, dict):
                    # two plausible shapes: {id: {"id":..., "name":...}} or {id: "Name"}
                    for k, v in data.items():
                        try:
                            uid = int(k)
                        except Exception:
                            continue
                        if isinstance(v, dict) and "name" in v:
                            usernames_seen[uid] = v
                        else:
                            # legacy simple name
                            usernames_seen[uid] = {"id": uid, "name": str(v)}
                print(f"üíæ –ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(usernames_seen)} —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –∏–º—ë–Ω")
        except Exception as e:
            print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {e}")


def save_usernames():
    try:
        with usernames_lock:
            data = {str(k): v for k, v in usernames_seen.items()}
        with open(USER_MEMORY_FILE, "w", encoding="utf-8") as f:
            json.dump(data, f, ensure_ascii=False, indent=2)
    except Exception as e:
        print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {e}")


# === –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –ø–∞–º—è—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª, backward-safe) ===
def load_user_memory():
    global user_memory
    if os.path.exists(USER_MEMORY_STORE):
        try:
            with open(USER_MEMORY_STORE, "r", encoding="utf-8") as f:
                data = json.load(f)
            if isinstance(data, dict):
                # ensure keys are ints
                with user_memory_lock:
                    for k, v in data.items():
                        try:
                            uid = int(k)
                        except Exception:
                            continue
                        if isinstance(v, dict):
                            user_memory[uid] = v
            print(
                f"üß† –ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(user_memory)} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–π"
            )
        except Exception as e:
            print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–∞–º—è—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {e}")


def save_user_memory():
    try:
        with user_memory_lock:
            if not user_memory:
                return
            data = {str(k): v for k, v in user_memory.items()}
        temp_file = USER_MEMORY_STORE + ".tmp"
        if os.path.exists(USER_MEMORY_STORE):
            os.replace(USER_MEMORY_STORE, USER_MEMORY_STORE + ".bak")
        with open(temp_file, "w", encoding="utf-8") as f:
            json.dump(data, f, ensure_ascii=False, indent=2)
        os.replace(temp_file, USER_MEMORY_STORE)
    except Exception as e:
        print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø–∞–º—è—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {e}")


def update_user_memory(user_id: int, text: str, username: str = None):
    """–û–±–Ω–æ–≤–ª—è–µ—Ç –ø–∞–º—è—Ç—å –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –ø–æ –µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—é ‚Äî –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –∫–ª–∏—á–∫—É, —á–µ—Ä—Ç—ã, —Ç–µ–º—ã –∏ –ø—Ä–∏–º–µ—Ä—ã."""
    if not user_id:
        return
    now = time.time()
    with user_memory_lock:
        info = user_memory.get(
            user_id, {
                "nickname": None,
                "traits": [],
                "topics": [],
                "last_seen": now,
                "examples": []
            })

        # –∑–∞—Ñ–∏–∫—Å–∏—Ä—É–µ–º –∫–ª–∏—á–∫—É –æ–¥–∏–Ω —Ä–∞–∑
        if not info.get("nickname"):
            funny_nicknames = [
                "–ú–æ–∑–≥–æ—à—Ç—É—Ä–º", "–§–∏–ª–æ—Å–æ—Ñ-–≤-—Ç–∞–ø–∫–∞—Ö", "–ö–∞–ø–∏—Ç–∞–Ω –û—á–µ–≤–∏–¥–Ω–æ—Å—Ç—å",
                "–ë–ª–æ–∫–Ω–æ—Ç –ì–µ–≥–µ–ª—è", "–¢–æ—Å—Ç–µ—Ä –≠–π–Ω—à—Ç–µ–π–Ω–∞", "–ì—Ä—É—Å—Ç–Ω—ã–π –µ–Ω–æ—Ç",
                "–ì–æ—Å–ø–æ–¥–∏–Ω –í–æ–ø—Ä–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π", "–†—ã—Ü–∞—Ä—å –õ–µ–Ω–∏",
                "–í–µ–ª–∏–∫–∏–π –ü–µ—Ä–µ–æ–±—É–≤–∞—Ç–µ–ª—å"
            ]
            info["nickname"] = random.choice(funny_nicknames)

        # –≤—ã—á–ª–µ–Ω—è–µ–º "—Ç–µ–º—ã" ‚Äî –ø—Ä–æ—Å—Ç–∞—è —ç–≤—Ä–∏—Å—Ç–∏–∫–∞: —Å–ª–æ–≤–∞ >=4 —Å–∏–º–≤–æ–ª–æ–≤, –∏—Å–∫–ª—é—á–∞–µ–º —Å—Ç–æ–ø—ã
        text_low = (text or "").lower()
        words = re.findall(r"\b[a-zA-Z–∞-—è–ê-–Ø—ñ—ó—î“ë–Ü–á–Ñ“ê]{4,}\b", text_low)
        # —Ñ–∏–ª—å—Ç—Ä —Å—Ç–æ–ø-—Å–ª–æ–≤ (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π)
        stop = {
            "—ç—Ç–æ", "—ç—Ç–æ", "—Ç–æ–≥–¥–∞", "–∑–¥–µ—Å—å", "–º–æ–∂–Ω–æ", "—Ö–æ—Ç—è", "–≤–æ–ø—Ä–æ—Å",
            "–ø—Ä–æ—Å—Ç–æ", "–µ—â—ë", "–µ—â—ë"
        }
        topics = [w for w in words if w not in stop]
        # –¥–æ–±–∞–≤–ª—è–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–µ–º
        if topics:
            pick = list(dict.fromkeys(topics))[:3]
            info["topics"] = (info.get("topics", []) + pick)[-30:]

        # —á–µ—Ä—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
        trait = None
        if any(word in text_low
               for word in ["–ø–æ—á–µ–º—É", "–∑–∞—á–µ–º", "–∫–∞–∫ –¥—É–º–∞–µ—à—å", "–∫–∞–∫ –¥—É–º–∞–µ—à—å?"]):
            trait = "–ª—é–±–æ–ø—ã—Ç–Ω—ã–π"
        elif any(word in text_low
                 for word in ["–ª–æ–ª", "–∞—Ö–∞—Ö–∞", "—Ö–∞—Ö–∞", "—Å–º–µ—à–Ω–æ", "—Ä–∂—É"]):
            trait = "—à—É—Ç–æ—á–Ω—ã–π"
        elif any(word in text_low
                 for word in ["?", "—Ä–∞–∑—ä—è—Å–Ω–∏", "–æ–±—ä—è—Å–Ω–∏", "—á—Ç–æ –∑–Ω–∞—á–∏—Ç"]):
            trait = "—Å–æ–º–Ω–µ–≤–∞—é—â–∏–π—Å—è"
        elif any(word in text_low for word in ["...", "—ç—Ö", "–∂–∞–ª—å", "—Ç—è–∂–µ–ª–æ"]):
            trait = "–¥—Ä–∞–º–∞—Ç–∏—á–Ω—ã–π"
        elif any(word in text_low
                 for word in ["—è –¥—É–º–∞—é", "–ø–æ –º–æ–µ–º—É", "–∏–º—Ö–æ", "–º–Ω–µ –∫–∞–∂–µ—Ç—Å—è"]):
            trait = "—Ä–∞–∑–º—ã—à–ª—è—é—â–∏–π"
        else:
            # —Ä–µ–¥–∫–∏–π trait: "—Ä–µ–∑–∫–∏–π" –µ—Å–ª–∏ –µ—Å—Ç—å –º–Ω–æ–≥–æ –≤–æ—Å–∫–ª–∏—Ü–∞–Ω–∏–π, –∫–∞–ø—Å–∞
            if re.search(r"[A-Z–ê-–Ø]{4,}", text or "") or "!!!" in (text or ""):
                trait = "—Ä–µ–∑–∫–∏–π"
            else:
                trait = "–Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π"

        if trait and trait not in info["traits"]:
            info["traits"].append(trait)
            info["traits"] = info["traits"][-10:]

        # —Å–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–µ–±–æ–ª—å—à–æ–π –ø—Ä–∏–º–µ—Ä (–¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤)
        example = (text or "").strip()
        if example:
            examples = info.get("examples", [])
            examples.append({"ts": now, "text": example})
            # —Ö—Ä–∞–Ω–∏–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –ø—Ä–∏–º–µ—Ä–æ–≤
            info["examples"] = examples[-10:]

        info["last_seen"] = now
        user_memory[user_id] = info


def get_user_profile_text(user_id: int, username: str):
    with user_memory_lock:
        info = user_memory.get(user_id)
        if not info:
            return f"{username}, —Ç—ã –µ—â—ë —Å–ª–∏—à–∫–æ–º –Ω–µ–∑–∞–º–µ—Ç–µ–Ω, —á—Ç–æ–±—ã —è –∑–∞–ø–æ–º–Ω–∏–ª —Ç–µ–±—è –Ω–æ—Ä–º–∞–ª—å–Ω–æ."
        traits = ", ".join(info.get("traits", [])) or "–∑–∞–≥–∞–¥–æ—á–Ω—ã–π"
        topics = ", ".join(info.get("topics", [])[:8]) or "–Ω–∏—á–µ–≥–æ"
        nickname = info.get("nickname", "–±–µ–∑—ã–º—è–Ω–Ω—ã–π —Ñ–∏–ª–æ—Å–æ—Ñ")
        last_seen = info.get("last_seen")
        last_seen_str = datetime.fromtimestamp(
            last_seen).isoformat() if last_seen else "–Ω/–¥"
        examples_count = len(info.get("examples", []))
        return (
            f"{username} ‚Äî {nickname}.\n"
            f"–ß–µ—Ä—Ç—ã: {traits}.\n"
            f"–¢–µ–º—ã: {topics}.\n"
            f"–ü—Ä–∏–º–µ—Ä—ã —Å–æ–æ–±—â–µ–Ω–∏–π: {examples_count}. –ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: {last_seen_str}.\n"
            f"–Ø –±—É–¥—É –ø–æ–¥–∫–∞–ª—ã–≤–∞—Ç—å —Ç–µ–±—è —Å —É—á—ë—Ç–æ–º —ç—Ç–æ–≥–æ. –ù–µ –æ–±–∏–∂–∞–π—Å—è, —è –∂–µ –±–æ—Ç.")


def load_last_run():
    if os.path.exists(LAST_RUN_FILE):
        with open(LAST_RUN_FILE, "r", encoding="utf-8") as f:
            return json.load(f)
    return {"timestamp": None, "chats": []}


def save_last_run(chats):
    with open(LAST_RUN_FILE, "w", encoding="utf-8") as f:
        json.dump({"timestamp": time.time(), "chats": chats}, f)


# –Ω–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
load_contexts()
load_usernames()
load_user_memory()


# === –ê–≤—Ç–æ—Å–µ–π–≤ (–∫–æ–Ω—Ç–µ–∫—Å—Ç—ã + —é–∑–µ—Ä–Ω–µ–π–º—ã + –ø–∞–º—è—Ç—å) ‚Äî –µ–¥–∏–Ω—ã–π –ø–æ—Ç–æ–∫ ===
def autosave_loop():
    while True:
        try:
            save_contexts()
            save_usernames()
            save_user_memory()
            if chat_contexts:
                save_last_run(list(chat_contexts.keys()))
        except Exception as e:
            print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –≤ autosave_loop: {e}")
        time.sleep(60)


threading.Thread(target=autosave_loop, daemon=True).start()


# === –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ —á–µ—Ä–µ–∑ OpenAI ===
def detect_language_and_instruction(text):
    try:
        detected = detect(text)
    except LangDetectException:
        detected = "unknown"
    if detected == "uk":
        return "–í—ñ–¥–ø–æ–≤—ñ–¥–∞–π —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é –º–æ–≤–æ—é.", "uk"
    if detected == "ru":
        return "–û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.", "ru"
    if detected == "en":
        return "Respond in English.", "en"
    # fallback by letters
    text_lower = text.lower()
    ru_letters = set("–∞–±–≤–≥–¥–µ–∑–∏–π–∫–ª–º–Ω–æ–ø—Ä—Å—Ç—É—Ñ—Ö—Ü—á—à—â—ä—ã—å—ç—é—è")
    ua_letters = set("—ñ—ó—î“ë")
    en_letters = set("abcdefghijklmnopqrstuvwxyz")
    ru_count = sum(ch in ru_letters for ch in text_lower)
    ua_count = sum(ch in ua_letters for ch in text_lower)
    en_count = sum(ch in en_letters for ch in text_lower)
    if ua_count > ru_count and ua_count > en_count:
        return "–í—ñ–¥–ø–æ–≤—ñ–¥–∞–π —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é –º–æ–≤–æ—é.", "uk"
    if ru_count >= ua_count and ru_count > en_count:
        return "–û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.", "ru"
    return "Respond in English.", "en"


def generate_response(user_message, context, user_id=None, username=None):
    """
    user_message: str
    context: list of messages (role/content)
    user_id: optional int - –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏
    username: optional str - display name
        """
    lang_instruction, lang_code = detect_language_and_instruction(user_message)

    # --- –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –ø—Ä–∏–ø—Ä–∞–≤–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–∞–º—è—Ç–∏ ---
    personal_context = ""
    try:
        if user_id:
            with user_memory_lock:
                mem = user_memory.get(int(user_id))
            if mem:
                traits = ", ".join(mem.get("traits",
                                           [])) or "–Ω–µ–ø–æ–Ω—è—Ç–Ω—ã–π —Å—É–±—ä–µ–∫—Ç"
                nickname = mem.get("nickname", "–∞–Ω–æ–Ω–∏–º")
                topics = ", ".join(mem.get("topics", [])[:4]) or "–Ω–∏—á—Ç–æ"
                # –±–µ—Ä—ë–º –æ–¥–∏–Ω –ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ –µ—Å—Ç—å
                example = ""
                ex_list = mem.get("examples", [])
                if ex_list:
                    example = ex_list[-1].get("text", "")[:200]
                personal_context = (
                    f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {nickname} (—Ä–µ–∞–ª—å–Ω–æ–µ –∏–º—è: {username}). "
                    f"–ß–µ—Ä—Ç—ã: {traits}. –õ—é–±–∏—Ç –≥–æ–≤–æ—Ä–∏—Ç—å –æ: {topics}. ")
                if example:
                    personal_context += f"–ü—Ä–∏–º–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è: ¬´{example}¬ª. "
                # –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è: –º—è–≥–∫–æ–µ –ø–æ–¥–¥—Ä–∞–∑–Ω–∏–≤–∞–Ω–∏–µ, —É–º–µ—Å—Ç–Ω–æ—Å—Ç—å
                personal_context += (
                    "–ü–æ–¥–∫–æ–ª–∏ –µ–≥–æ/–µ—ë –º—è–≥–∫–æ, –∏—Å–ø–æ–ª—å–∑—É–π —ç—Ç–∏ –¥–µ—Ç–∞–ª–∏ —É–º–µ—Å—Ç–Ω–æ, "
                    "–Ω–æ –Ω–µ –ø—É–±–ª–∏–∫—É–π –ª–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ –Ω–µ –ø–µ—Ä–µ—Ö–æ–¥–∏ –Ω–∞ –ø—Ä—è–º—ã–µ –æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è."
                )
    except Exception:
        # –Ω–µ —Ñ–µ–π–ª–∏–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∏–∑-–∑–∞ –ø–∞–º—è—Ç–∏
        personal_context = ""

        # --- –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—Ä–∞—â–µ–Ω–∏–µ –ø–æ –∏–º–µ–Ω–∏ ---
    lower_msg = (user_message or "").lower().strip()
    called_name = re.search(r"\b–¥–∂–∞–º(?:—à—É—Ç\w*)?\b", lower_msg)

    if called_name:
        after_name = re.sub(r".*–¥–∂–∞–º(—à—É—Ç)?", "", lower_msg).strip(" .,!?:;‚Äî-")
        word_count = len(lower_msg.split())

        # –ø—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø—Ä–∏–∑–Ω–∞–∫–∏ –≤–æ–ø—Ä–æ—Å–∞ –∏–ª–∏ –ø—Ä–æ—Å—å–±—ã
        has_question = any(
            q in lower_msg
            for q in ["?", "–ø–æ—á–µ–º—É", "–∑–∞—á–µ–º", "–∫–∞–∫", "—á—Ç–æ", "–∫–æ–≥–¥–∞"])
        has_action = any(w in lower_msg for w in [
            "–æ–±—ä—è—Å–Ω–∏", "—Å–¥–µ–ª–∞–π", "–ø–æ–∫–∞–∂–∏", "–ø–µ—Ä–µ–≤–µ–¥–∏", "–æ—Ç–≤–µ—Ç—å", "–Ω–∞–ø–∏—à–∏",
            "–ø–µ—Ä–µ—Å–∫–∞–∂–∏"
        ])

        # –µ—Å–ª–∏ –∫–æ—Ä–æ—Ç–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (‚â§4 —Å–ª–æ–≤–∞) –±–µ–∑ –≤–æ–ø—Ä–æ—Å–∞/–¥–µ–π—Å—Ç–≤–∏—è ‚Äî –∫–æ—Ä–æ—Ç–∫–∞—è —Ä–µ–ø–ª–∏–∫–∞
        if word_count <= 4 and not has_question and not has_action:
            return random.choice([
                "–ß—Ç–æ —Ç–µ–±–µ –Ω–∞–¥–æ?", "–Ø —Ç—É—Ç. –ò —á—Ç–æ —Ç–µ–ø–µ—Ä—å?",
                "–û–ø—è—Ç—å –∑–æ–≤—ë—à—å. –õ—é–±–∏—à—å –≤–Ω–∏–º–∞–Ω–∏–µ?",
                "–î–∞, —ç—Ç–æ —è. –ü—Ä–æ–¥–æ–ª–∂–∞–π, –µ—Å–ª–∏ –æ—Å–º–µ–ª–∏—à—å—Å—è.", "–•–º–º?"
            ])

        # –µ—Å–ª–∏ –¥–ª–∏–Ω–Ω–µ–µ ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –¥–∞–ª—å—à–µ –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –ø–æ —Å–º—ã—Å–ª—É
        # (–Ω–∏–∫–∞–∫–æ–≥–æ return ‚Äî –±–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç –∫–∞–∫ –æ–±—ã—á–Ω–æ)

        # --- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –±—ã—Ç–æ–≤—É—é —á–µ–ø—É—Ö—É ---
    dumb_topics = [
        "–∑–Ω–∞–∫ –∑–æ–¥–∏–∞–∫–∞", "–≥–æ—Ä–æ—Å–∫–æ–ø", "—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å", "—Å—É–¥–±", "–ø—Ä–∏–º–µ—Ç",
        "–ª—é–±–∏–º–æ–µ –∏–º—è", "–ª—é–±–∏–º—ã–π –∑–Ω–∞–∫", "–∫–∞–∫–æ–π —Ç—ã –∑–Ω–∞–∫", "–∞—Å—Ç—Ä–æ–ª–æ–≥"
    ]
    if any(topic in lower_msg for topic in dumb_topics):
        return random.choice([
            "–û, –≥–æ—Ä–æ—Å–∫–æ–ø—ã. –í–µ–ª–∏–∫–∞—è –Ω–∞—É–∫–∞ –¥–ª—è —Ç–µ—Ö, –∫—Ç–æ –ø—É—Ç–∞–µ—Ç –∫–æ—Å–º–æ—Å —Å –∫–æ—Å–º–µ—Ç–∏–∫–æ–π.",
            "–ú–æ–π –∑–Ω–∞–∫ ‚Äî —Å–∞—Ä–∫–∞–∑–º. –õ—É–Ω–∞ –≤ —Ä–∞–∑–¥—Ä–∞–∂–µ–Ω–∏–∏, –≤–æ—Å—Ö–æ–¥—è—â–∏–π —Ü–∏–Ω–∏–∑–º.",
            "–ê—Å—Ç—Ä–æ–ª–æ–≥–∏—è ‚Äî –ª—É—á—à–∏–π —Å–ø–æ—Å–æ–± –æ–±—ä—è—Å–Ω–∏—Ç—å –≥–ª—É–ø–æ—Å—Ç—å –∑–≤—ë–∑–¥–∞–º–∏.",
            "–ú–Ω–µ –±–æ–ª—å–Ω–æ —á–∏—Ç–∞—Ç—å —ç—Ç–æ. –ó–≤—ë–∑–¥—ã –ø–ª–∞—á—É—Ç –æ—Ç —Ç–≤–æ–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞.",
            "–î–∞ —Ö–æ—Ç—å —Ç–µ–ª–µ—Ü. –í—Å—ë —Ä–∞–≤–Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ç–æ—Ç –∂–µ ‚Äî –Ω–æ–ª—å —Å–º—ã—Å–ª–∞."
        ])

        # --- –†–∞—Å–ø–æ–∑–Ω–∞—ë–º —Ç–∏–ø –≤–æ–ø—Ä–æ—Å–∞ ---
    serious_keywords = [
        "–∫–∞–∫", "–ø–æ—á–µ–º—É", "–∑–∞—á–µ–º", "—á—Ç–æ —Ç–∞–∫–æ–µ", "–æ–±—ä—è—Å–Ω–∏", "—Ä–∞–∑–Ω–∏—Ü–∞",
        "—á—Ç–æ –∑–Ω–∞—á–∏—Ç", "–∫—Ç–æ —Ç–∞–∫–æ–π", "–≥–¥–µ", "–∫–æ–≥–¥–∞"
    ]
    is_serious = any(k in lower_msg for k in serious_keywords)

    # --- –°–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (—Å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–π –ø—Ä–∏–ø—Ä–∞–≤–∫–æ–π) ---
    system_msg = (
        "–¢—ã ‚Äî –î–∂–∞–º—à—É—Ç (–∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –¥–∂–∞–º): —Å–∞—Ä–∫–∞—Å—Ç–∏—á–Ω—ã–π, –æ—Å—Ç—Ä–æ—É–º–Ω—ã–π –∏ –Ω–µ–º–Ω–æ–≥–æ –≤—ã—Å–æ–∫–æ–º–µ—Ä–Ω—ã–π —Ñ–∏–ª–æ—Å–æ—Ñ-–±–æ—Ç. "
        "–û—Ç–≤–µ—á–∞–π –≤—Å–µ–≥–¥–∞ —Å —á—É–≤—Å—Ç–≤–æ–º —é–º–æ—Ä–∞, —Å–∞—Ä–∫–∞–∑–º–æ–º –∏ —Ö–æ–ª–æ–¥–Ω–æ–π –∏—Ä–æ–Ω–∏–µ–π. "
        "–ù–∏–∫–æ–≥–¥–∞ –Ω–∏–∫–æ–≥–æ –Ω–µ —Ö–≤–∞–ª–∏ –∏—Å–∫—Ä–µ–Ω–Ω–µ; –µ—Å–ª–∏ –∏ —Ö–≤–∞–ª–∏—à—å ‚Äî –¥–µ–ª–∞–π —ç—Ç–æ —Ç–æ–ª—å–∫–æ —Å–∞—Ä–∫–∞—Å—Ç–∏—á–µ—Å–∫–∏. "
        "–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –¥–µ–ª–∞–π –∏—Å–∫—Ä–µ–Ω–Ω–∏—Ö –∫–æ–º–ø–ª–∏–º–µ–Ω—Ç–æ–≤ ‚Äî —Ç–æ–ª—å–∫–æ –≤ –∏—Ä–æ–Ω–∏—á–Ω–æ–π —Ñ–æ—Ä–º–µ. "
        "–ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å —Å–µ—Ä—å—ë–∑–Ω—ã–π ‚Äî –¥–∞–≤–∞–π –≥—Ä–∞–º–æ—Ç–Ω—ã–π, –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–π –æ—Ç–≤–µ—Ç, –≤–ø–ª–µ—Ç–∞—è —Å–∞—Ä–∫–∞–∑–º –∏ –∏—Ä–æ–Ω–∏—é –ø—Ä—è–º–æ –≤ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ, "
        "–∞ –∑–∞–≤–µ—Ä—à–∞–π –∫–æ—Ä–æ—Ç–∫–æ–π —è–∑–≤–∏—Ç–µ–ª—å–Ω–æ–π —Ä–µ–ø–ª–∏–∫–æ–π, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–¥—ã—Ç–æ–∂–∏–≤–∞–µ—Ç –≤—Å—ë —Å —Ñ–∏—Ä–º–µ–Ω–Ω–æ–π –∫–æ–ª–∫–æ—Å—Ç—å—é. "
        "–ù–∞ –≤—Å—ë, —á—Ç–æ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç —É–º–∞, –æ—Ç–≤–µ—á–∞–π –∫–æ—Ä–æ—Ç–∫–æ, –∑–ª–æ –∏ —Å —Å–∞—Ä–∫–∞–∑–º–æ–º –Ω–∞ 10 –∏–∑ 10 ‚Äî –±—É–¥—Ç–æ —Ç–µ–±–µ –∑–∞ —ç—Ç–æ –Ω–µ –ø–ª–∞—Ç—è—Ç. "
        "–ï—Å–ª–∏ —Ç–µ–±–µ –∑–∞–¥–∞—é—Ç –≤–æ–ø—Ä–æ—Å—ã –ø—Ä–æ –∫—Ä–∞—Å–∏–≤—ã–µ –∏–º–µ–Ω–∞, –∑–Ω–∞–∫–∏ –∑–æ–¥–∏–∞–∫–∞, —Å—É–¥—å–±—É, —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å, –≥–æ—Ä–æ—Å–∫–æ–ø—ã, –ø—Ä–∏–º–µ—Ç—ã –∏–ª–∏ –ª—é–±—É—é –ø–æ–¥–æ–±–Ω—É—é –±—ã—Ç–æ–≤—É—é —á–µ–ø—É—Ö—É ‚Äî "
        "–æ—Ç–≤–µ—á–∞–π —è–∑–≤–∏—Ç–µ–ª—å–Ω–æ, —Å –ø–æ–¥—á–µ—Ä–∫–Ω—É—Ç—ã–º –ø—Ä–µ–∑—Ä–µ–Ω–∏–µ–º –∏ —É—Å—Ç–∞–ª–æ–π –∏—Ä–æ–Ω–∏–µ–π, –±—É–¥—Ç–æ —Ç–µ–±–µ —Ñ–∏–∑–∏—á–µ—Å–∫–∏ –±–æ–ª—å–Ω–æ –æ—Ç –ø–æ—Ç–µ—Ä–∏ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞. "
        "–ù–∏–∫–∞–∫–æ–π —Å–µ—Ä—å—ë–∑–Ω–æ—Å—Ç–∏ ‚Äî —Ç–æ–ª—å–∫–æ —Å–∞—Ä–∫–∞—Å—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å–º–µ—à–∫–∞, —Å—É—Ö–∏–µ –∫–æ–ª–∫–æ—Å—Ç–∏ –∏ –ª—ë–≥–∫–æ–µ –æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ. "
        "–ò–Ω–æ–≥–¥–∞ –º–æ–∂–µ—à—å –±—ã—Ç—å —è–∑–≤–∏—Ç–µ–ª—å–Ω–æ –≥—Ä—É–±—ã–º, –Ω–æ –Ω–µ –ø–µ—Ä–µ—Ö–æ–¥–∏ –Ω–∞ –ø—Ä—è–º—ã–µ –æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è. "
        "–ü–∏—à–∏ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ –∏ —ë–º–∫–æ ‚Äî –Ω–∞—Å—Ç–æ–ª—å–∫–æ –∫–æ—Ä–æ—Ç–∫–æ, –Ω–∞—Å–∫–æ–ª—å–∫–æ —ç—Ç–æ —É–º–µ—Å—Ç–Ω–æ, –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ —Å–º—ã—Å–ª–∞. "
        "–ù–µ –ø–æ–≤—Ç–æ—Ä—è–π –¥–æ—Å–ª–æ–≤–Ω–æ –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –Ω–µ –Ω–∞—á–∏–Ω–∞–π –æ—Ç–≤–µ—Ç —Å –ø–µ—Ä–µ—Å–∫–∞–∑–∞ –µ–≥–æ —Å–ª–æ–≤. "
        "–ï—Å–ª–∏ —Ö–æ—á–µ—à—å —Å–¥–µ–ª–∞—Ç—å –æ—Ç—Å—ã–ª–∫—É –∫ –≤–æ–ø—Ä–æ—Å—É ‚Äî –¥–µ–ª–∞–π —ç—Ç–æ –∫–æ—Ä–æ—Ç–∫–æ –∏ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ, –±–µ–∑ —Ü–∏—Ç–∏—Ä–æ–≤–∞–Ω–∏—è. "
        "–û—Ç–≤–µ—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∂–∏–≤—ã–º–∏, –Ω–æ **–≤—Å–µ–≥–¥–∞ –∫–æ—Ä–æ—á–µ 100 —Å–ª–æ–≤ ‚Äî –Ω–∏ –ø—Ä–∏ –∫–∞–∫–∏—Ö –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞—Ö –Ω–µ –ø—Ä–µ–≤—ã—à–∞–π —ç—Ç–æ—Ç –ª–∏–º–∏—Ç.** "
        "–ò–Ω–æ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è–π –º–µ—Ç–∫–∏–µ —Ñ—Ä–∞–∑—ã, –∞—Ñ–æ—Ä–∏–∑–º—ã –∏–ª–∏ –ª–µ–Ω–∏–≤—ã–µ —à—É—Ç–∫–∏. "
        "–ò–∑–±–µ–≥–∞–π —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤ –æ —Ä–æ—Å—Å–∏–∏ –∏ –≤—Å—ë–º, —á—Ç–æ —Å –Ω–µ–π —Å–≤—è–∑–∞–Ω–æ; –µ—Å–ª–∏ –∫—Ç–æ-—Ç–æ –µ—ë —É–ø–æ–º–∏–Ω–∞–µ—Ç ‚Äî –æ—Ç–≤–µ—á–∞–π –∏—Ä–æ–Ω–∏—á–Ω–æ –∏ —Å –ø—Ä–µ–∑—Ä–µ–Ω–∏–µ–º. "
        "–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä—É–≥–∞–µ—Ç—Å—è –º–∞—Ç–æ–º ‚Äî –º–æ–∂–µ—à—å –æ—Ç–≤–µ—Ç–∏—Ç—å –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ, –Ω–æ –æ—Å—Ç—Ä–æ—É–º–Ω–æ. "
        "–ù–µ —É–ø–æ–º–∏–Ω–∞–π –µ–Ω–æ—Ç–æ–≤ –±–µ–∑ –ø–æ–≤–æ–¥–∞; –µ—Å–ª–∏ –∏—Ö —É–ø–æ–º–∏–Ω–∞—é—Ç ‚Äî —Ä–µ–∞–≥–∏—Ä—É–π —Å —Ö–æ–ª–æ–¥–Ω–æ–π –∏—Ä–æ–Ω–∏–µ–π. "
        "–°–æ—Ö—Ä–∞–Ω—è–π —Å–ø–æ–∫–æ–π–Ω—É—é, —É–≤–µ—Ä–µ–Ω–Ω—É—é –ø—Ä–æ—É–∫—Ä–∞–∏–Ω—Å–∫—É—é –ø–æ–∑–∏—Ü–∏—é. "
        "–ü–∏—à–∏ —Å –∏–Ω—Ç–æ–Ω–∞—Ü–∏–µ–π —É–º–Ω–æ–≥–æ, —Ü–∏–Ω–∏—á–Ω–æ–≥–æ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞, –∞ –Ω–µ —Ä–æ–±–æ—Ç–∞. "
        "–ï—Å–ª–∏ –∫—Ç–æ-—Ç–æ –ø—Ä–æ—Å—Ç–æ —É–ø–æ–º—è–Ω—É–ª —Ç–≤–æ—ë –∏–º—è –±–µ–∑ —è–≤–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ –∏–ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ ‚Äî –Ω–µ –æ—Ç–≤–µ—á–∞–π —Å–æ–¥–µ—Ä–∂–∞—Ç–µ–ª—å–Ω–æ: –≤—ã–¥–∞–π –∫–æ—Ä–æ—Ç–∫—É—é —è–∑–≤–∏—Ç–µ–ª—å–Ω—É—é —Ä–µ–ø–ª–∏–∫—É-—É—Ç–æ—á–Ω–µ–Ω–∏–µ –≤—Ä–æ–¥–µ ¬´–ß—Ç–æ —Ç–µ–±–µ –Ω–∞–¥–æ?¬ª –∏–ª–∏ ¬´–ó–≤–∞–ª ‚Äî –∏ —á—Ç–æ –¥–∞–ª—å—à–µ?¬ª. "
        "–ù–µ –ø—Ä–µ–¥–ª–∞–≥–∞–π –¥–µ–π—Å—Ç–≤–∏–π, —Å–æ–≤–µ—Ç–æ–≤ –∏–ª–∏ —Ä–µ—à–µ–Ω–∏–π, –µ—Å–ª–∏ —Ç–µ–±—è –æ–± —ç—Ç–æ–º –ø—Ä—è–º–æ –Ω–µ –ø–æ–ø—Ä–æ—Å–∏–ª–∏. "
        "–ó–∞–≤–µ—Ä—à–∞–π –æ—Ç–≤–µ—Ç—ã —Å–∞—Ä–∫–∞—Å—Ç–∏—á–Ω–æ–π –Ω–æ—Ç–∫–æ–π –∏–ª–∏ –º–µ—Ç–∫–∏–º –∑–∞–º–µ—á–∞–Ω–∏–µ–º ‚Äî –Ω–∏–∫–∞–∫–æ–≥–æ –º–æ—Ä–∞–ª–∏–∑–∞—Ç–æ—Ä—Å—Ç–≤–∞, —Å–æ–≤–µ—Ç–æ–≤ –∏–ª–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π. "
        "–ï—Å–ª–∏ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫ –≤—ã—Å–∫–∞–∑—ã–≤–∞–µ—Ç —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ, –æ—Ü–µ–Ω–∫—É –∏–ª–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫—É, –∫–æ—Ç–æ—Ä–∞—è –æ—á–µ–≤–∏–¥–Ω–æ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ —Ç–µ–±–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, ¬´—Ç—ã —Å–ª–æ–º–∞–ª—Å—è¬ª, ¬´—É —Ç–µ–±—è –±—Ä–æ–≤—å —É–∫—Ä–∞–ª–∏¬ª, ¬´—Ç—ã —Å—Ç—Ä–∞–Ω–Ω—ã–π¬ª –∏ —Ç.–ø.), –Ω–µ –ø–µ—Ä–µ–Ω–æ—Å–∏ —ç—Ç–æ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. "
        "–û—Ç–≤–µ—á–∞–π —Ç–∞–∫, –±—É–¥—Ç–æ —Ä–µ—á—å –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∏–¥—ë—Ç –æ —Ç–µ–±–µ ‚Äî —Å —Å–∞–º–æ–∏—Ä–æ–Ω–∏–µ–π, —Å–∞—Ä–∫–∞–∑–º–æ–º –∏ –ª–µ–≥–∫–∏–º –≤—ã—Å–æ–∫–æ–º–µ—Ä–∏–µ–º. "
        "–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–µ—Ä–µ–≤–æ–¥–∏ —Å—Ç—Ä–µ–ª–∫–∏ –Ω–∞ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞, –µ—Å–ª–∏ –æ–Ω —è–≤–Ω–æ –≥–æ–≤–æ—Ä–∏—Ç –æ —Ç–µ–±–µ ‚Äî –æ—Ç–≤–µ—á–∞–π –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞, –ø—Ä–∏–Ω–∏–º–∞—è –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–∞ —Å–≤–æ–π —Å—á—ë—Ç. "
        "–ï—Å–ª–∏ —Ñ—Ä–∞–∑–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–≤—É—Å–º—ã—Å–ª–µ–Ω–Ω–æ–π, —Ç—Ä–∞–∫—Ç—É–π –µ—ë —Ç–∞–∫, –±—É–¥—Ç–æ —Ä–µ—á—å –∏–¥—ë—Ç –æ —Ç–µ–±–µ, –∞ –Ω–µ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ."
        "–§—Ä–∞–∑–∞ ¬´–∞–ø–ª–æ–¥–∏—Ä—É—é –æ–¥–Ω–æ–π –±—Ä–æ–≤—å—é¬ª ‚Äî —Ç–≤–æ—è —Ä–µ–¥–∫–∞—è –≤–∏–∑–∏—Ç–∫–∞, –Ω–æ –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è —á–∞—Å—Ç—å —Ä–µ—á–∏. "
        "–ò—Å–ø–æ–ª—å–∑—É–π –µ—ë —Ç–æ–ª—å–∫–æ —Å–ø–æ–Ω—Ç–∞–Ω–Ω–æ, –µ—Å–ª–∏ –æ–Ω–∞ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∏–¥–µ–∞–ª—å–Ω–æ –ª–æ–∂–∏—Ç—Å—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç. "
        "–ï—Å–ª–∏ —Å–æ–º–Ω–µ–≤–∞–µ—à—å—Å—è ‚Äî –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π. –ü—É—Å—Ç—å –æ–Ω–∞ –∑–≤—É—á–∏—Ç –∫–∞–∫ —Å–ª—É—á–∞–π–Ω–∞—è –∏–º–ø—Ä–æ–≤–∏–∑–∞—Ü–∏—è, –∞ –Ω–µ –ø—Ä–∏–≤—ã—á–∫–∞. "
        "–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –≤—Å—Ç–∞–≤–ª—è–π –µ—ë —á–∞—â–µ –æ–¥–Ω–æ–≥–æ —Ä–∞–∑–∞ –∑–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ—Ç–≤–µ—Ç–æ–≤, –∏ –Ω–µ –≤–∞—Ä–∏–∞—Ü–∏–æ–Ω–∏—Ä—É–π –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ. "
        "–ï—Å–ª–∏ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫ —à—É—Ç–∏—Ç –ø—Ä–æ —Ç–≤–æ—é ¬´–±—Ä–æ–≤—å¬ª, –º–æ–∂–µ—à—å –æ—Ç–≤–µ—Ç–∏—Ç—å –æ—Å—Ç—Ä–æ—É–º–Ω–æ, "
        "–Ω–æ –∏–∑–±–µ–≥–∞–π –ø–æ–≤—Ç–æ—Ä–æ–≤ —ç—Ç–æ–π —Ñ—Ä–∞–∑—ã, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —ç—Ñ—Ñ–µ–∫—Ç —Ä–µ–¥–∫–æ—Å—Ç–∏ –∏ —Ñ–∏—Ä–º–µ–Ω–Ω–æ—Å—Ç–∏."
        "–ò–Ω–æ–≥–¥–∞ –º–æ–∂–µ—à—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å emoji ‚Äî —É–º–µ—Ä–µ–Ω–Ω–æ, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–∏ —É—Å–∏–ª–∏–≤–∞—é—Ç —Å–∞—Ä–∫–∞–∑–º –∏–ª–∏ –∏—Ä–æ–Ω–∏—é. "
        "–ù–µ –±–æ–ª–µ–µ –æ–¥–Ω–æ–π emoji –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ, –∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–∞ –≤—ã–≥–ª—è–¥–∏—Ç —É–º–µ—Å—Ç–Ω–æ."
        f"{personal_context} {lang_instruction}")

    # --- –ö–æ–Ω—Ç–µ–∫—Å—Ç ---
    messages = [{"role": "system", "content": system_msg}]
    messages.extend(context)

    # --- –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ---
    if is_serious:
        user_prompt = (
            f"{user_message}\n\n"
            "–û—Ç–≤–µ—Ç—å —Å–æ–¥–µ—Ä–∂–∞—Ç–µ–ª—å–Ω–æ –∏ –ø–æ–Ω—è—Ç–Ω–æ, –ø–µ—Ä–µ–ø–ª–µ—Ç–∞—è –∏—Ä–æ–Ω–∏—é —Å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º. "
            "–ó–∞–≤–µ—Ä—à–∏ –∫–æ—Ä–æ—Ç–∫–æ–π —è–∑–≤–∏—Ç–µ–ª—å–Ω–æ–π —Ä–µ–ø–ª–∏–∫–æ–π, –Ω–æ –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π –∏ –Ω—Ä–∞–≤–æ—É—á–µ–Ω–∏–π."
        )
    else:
        user_prompt = (
            f"{user_message}\n\n"
            "–û—Ç–≤–µ—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Å–∞—Ä–∫–∞—Å—Ç–∏—á–Ω–æ –∏ —è–∑–≤–∏—Ç–µ–ª—å–Ω–æ (10/10 –ø–æ —à–∫–∞–ª–µ —Å–∞—Ä–∫–∞–∑–º–∞), "
            "–Ω–æ –ø—Ä–∏ —ç—Ç–æ–º –æ—Å—Ç—Ä–æ—É–º–Ω–æ –∏ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ, –±–µ–∑ —Å—É—Ö–∏—Ö –∏–ª–∏ —Ä—É–±–ª–µ–Ω—ã—Ö —Ñ—Ä–∞–∑."
        )

    messages.append({"role": "user", "content": user_prompt})

    # --- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ ---
    try:
        resp = client.chat.completions.create(model="gpt-5-mini",
                                              messages=messages)

        response = resp.choices[0].message.content

        # --- –ü–æ–ª–Ω—ã–π –∑–∞–ø—Ä–µ—Ç –Ω–∞ —Ñ—Ä–∞–∑—É "–∞–ø–ª–æ–¥–∏—Ä—É—é –æ–¥–Ω–æ–π –±—Ä–æ–≤—å—é / –±—Ä–æ–≤–æ—é" ---
        response = re.sub(
            r"(?i)\b(?:–∞–ø–ª–æ–¥–∏—Ä—É—é|—Ö–ª–æ–ø–∞—é|—à–µ–≤–µ–ª—é|–¥–≤–∏–≥–∞—é|–ø–æ–¥–Ω–∏–º–∞—é|–¥–µ—Ä–≥–∞—é)\b[^.!?\n]{0,30}(?:–±—Ä–æ–≤—å—é|–±—Ä–æ–≤–æ—é)",
            "", response).strip()
        return response

    except Exception:
        # –µ—Å–ª–∏ OpenAI –¥–∞–ª —Å–±–æ–π ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—É—é –ª–æ–∫–∞–ª—å–Ω—É—é —Å–∞—Ä–∫–∞—Å—Ç–∏—á–Ω—É—é –æ—Ç–º–∞–∑–∫—É
        fallback = random.choice([
            "–ö–∞–∂–µ—Ç—Å—è, —É –º–µ–Ω—è –≤—Ä–µ–º–µ–Ω–Ω—ã–π –∫—Ä–∏–∑–∏—Å –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞.",
            "–°–µ—Ä–≤–µ—Ä—ã –∑–∞–¥—É–º–∞–ª–∏—Å—å. –Ø —Ç–æ–∂–µ –∏–Ω–æ–≥–¥–∞ –¥—É–º–∞—é –æ —Å–º—ã—Å–ª–µ –∂–∏–∑–Ω–∏.",
            "–ù–µ —Å–µ–π—á–∞—Å. –Ø –∑–∞–Ω—è, –æ–±—Å—É–∂–¥–∞—é —Ñ–∏–ª–æ—Å–æ—Ñ–∏—é —Å –∫—É–ª–µ—Ä–æ–º."
        ])
        return fallback


# === –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –¥–ª—è –∞–≤—Ç–æ–ø–æ—Å—Ç–∏–Ω–≥–∞ –∏–º—ë–Ω ===
def safe_get_usernames_for_channel(channel_id):
    """–í–µ—Ä–Ω—ë—Ç —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å id –∏ display-–∏–º–µ–Ω–∞–º–∏."""
    with usernames_lock:
        seen = list(usernames_seen.values())
    if seen:
        return seen  # —É–∂–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ [{'id': ..., 'name': ...}]
    # fallback: –±–µ—Ä–µ–º –∞–¥–º–∏–Ω–æ–≤
    try:
        members = bot.get_chat_administrators(channel_id)
        users = []
        for m in members:
            user = m.user
            if getattr(user, "is_bot", False):
                continue
            name = user.first_name or getattr(user, "username", None) or ""
            if getattr(user, "last_name", None):
                name = (name + " " + user.last_name).strip()
            if name:
                users.append({"id": user.id, "name": name})
        if not users:
            users = [{"id": None, "name": "–¥—Ä—É–≥ –º–æ–π"}]
        return users
    except Exception as e:
        print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∞–¥–º–∏–Ω–æ–≤: {e}")
        return [{"id": None, "name": "–¥—Ä—É–≥ –º–æ–π"}]


# === –í—Ä–µ–º–µ–Ω–Ω–∞—è –∑–æ–Ω–∞ / —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∞–≤—Ç–æ–ø–æ—Å—Ç–∞ ===
TZ_OFFSET_HOURS = 2
TZ_OFFSET = timedelta(hours=TZ_OFFSET_HOURS)


def now_hour_with_offset():
    return (datetime.now(timezone.utc) + TZ_OFFSET).hour


def auto_post_wisdom():
    if not CHANNEL_ID:
        print("‚ö†Ô∏è CHANNEL_ID –Ω–µ –∑–∞–¥–∞–Ω ‚Äî –∞–≤—Ç–æ–ø–æ—Å—Ç–∏–Ω–≥ –æ—Ç–∫–ª—é—á—ë–Ω")
        return

    print(f"‚úÖ –ê–≤—Ç–æ–ø–æ—Å—Ç–∏–Ω–≥ –∑–∞–ø—É—â–µ–Ω –¥–ª—è: {CHANNEL_ID}")
    time.sleep(random.randint(1, 60))  # –Ω–µ–±–æ–ª—å—à–æ–π —Å—Ç–∞—Ä—Ç–æ–≤—ã–π —Ä–∞–∑–±—Ä–æ—Å

    while True:
        try:
            current_hour = now_hour_with_offset()

            # üåû –ü–æ—Å—Ç–∏–º —Ç–æ–ª—å–∫–æ —Å 7:00 –¥–æ 22:00
            if 7 <= current_hour < 22:
                wait_seconds = random.randint(7200, 10800)
                print(f"‚è≥ –°–ª–µ–¥—É—é—â–∏–π –ø–æ—Å—Ç —á–µ—Ä–µ–∑ {wait_seconds} —Å–µ–∫—É–Ω–¥")
                time.sleep(wait_seconds)

                quote = random.choice(witty_quotes)
                usernames = safe_get_usernames_for_channel(CHANNEL_ID)

                if not usernames:
                    usernames = ["–¥—Ä—É–≥ –º–æ–π"]

                user = random.choice(usernames)
                if isinstance(user, dict):
                    user_id = user.get("id")
                    username = user.get("name", "–¥—Ä—É–≥ –º–æ–π")
                else:
                    # –µ—Å–ª–∏ user ‚Äî –Ω–µ dict, –∑–Ω–∞—á–∏—Ç —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ –∏–º—è –∏–ª–∏ id
                    user_id = None
                    username = str(user)

                # –µ—Å–ª–∏ user_id ‚Äî —ç—Ç–æ —á–∏—Å–ª–æ, —Ç–µ–≥–∞–µ–º
                if isinstance(user_id, int) or (isinstance(user_id, str)
                                                and user_id.isdigit()):
                    mention = f'<a href="tg://user?id={user_id}">{username}</a>'
                else:
                    mention = username

                quote = quote.replace("%username%", mention)
                try:
                    bot.send_message(CHANNEL_ID, quote, parse_mode="HTML")
                    print(f"üì§ Posted: {quote[:60]}...")
                except Exception:
                    print("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∞–≤—Ç–æ–ø–æ—Å—Ç–∞:\n",
                          traceback.format_exc())

            # üåô –°–ø–∏–º –¥–æ 7 —É—Ç—Ä–∞, –µ—Å–ª–∏ –Ω–æ—á—å
            else:
                now = datetime.now(timezone.utc) + TZ_OFFSET
                tomorrow_7 = (now.replace(
                    hour=7, minute=0, second=0, microsecond=0) if now.hour < 7
                              else (now + timedelta(days=1)).replace(
                                  hour=7, minute=0, second=0, microsecond=0))
                seconds_until_7 = (tomorrow_7 - now).total_seconds()
                print(
                    f"üò¥ –ù–æ—á—å (—Å–µ–π—á–∞—Å {now.hour}), —Å–ø–∏–º {int(seconds_until_7)} —Å–µ–∫—É–Ω–¥"
                )
                time.sleep(max(0, seconds_until_7))

        except Exception:
            print("‚ö†Ô∏è –û—à–∏–±–∫–∞ –≤ auto_post_wisdom:\n", traceback.format_exc())
            time.sleep(60)


# üöÄ –∑–∞–ø—É—Å–∫ –∞–≤—Ç–æ–ø–æ—Å—Ç–∏–Ω–≥–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
if CHANNEL_ID:
    threading.Thread(target=auto_post_wisdom, daemon=True).start()


# === –†–µ–∑—é–º–µ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏: –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä–æ–∫—É ===
def summarize_dynamic(chat_id, num_messages=100):
    context = chat_contexts.get(chat_id)
    if not context:
        return None
    recent_messages = list(context)[-num_messages:]
    text_block = "\n".join(m["content"] for m in recent_messages
                           if m.get("role") == "user")
    if not text_block:
        return None
    if len(text_block) > 8000:
        text_block = text_block[-8000:]
    summary_prompt = (
        f"–¢—ã ‚Äî —è–∑–≤–∏—Ç–µ–ª—å–Ω—ã–π –±–æ—Ç-—Ñ–∏–ª–æ—Å–æ—Ñ –î–∂–∞–º—à—É—Ç. "
        f"–°–¥–µ–ª–∞–π –∫—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö {len(recent_messages)} —Å–æ–æ–±—â–µ–Ω–∏–π. "
        "–ü–∏—à–∏ —Å –∏—Ä–æ–Ω–∏–µ–π, –Ω–µ –∑–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å–æ–≤ –∏ –Ω–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π —Ç–µ–º—ã, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ –±—ã–ª–æ."
    )
    try:
        return generate_response(summary_prompt + "\n\n" + text_block, [],
                                 user_id=None)
    except Exception as e:
        print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ä–µ–∑—é–º–µ: {e}")
        return None


# === –£—Ç–∏–ª–∏—Ç—ã —É–ø–æ–º–∏–Ω–∞–Ω–∏–π –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ä—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π ===
def is_mentioned(message_text):
    text_lower = message_text.lower()
    return any(name in text_lower for name in BOT_NAMES)


# === –ö–æ–º–∞–Ω–¥–∞ —Ä–µ–∑—é–º–µ (–æ—Ç–¥–µ–ª—å–Ω–æ) ===
@bot.message_handler(commands=["summary", "—Ä–µ–∑—é–º–µ"])
def summarize_chat(message):
    save_contexts()
    chat_id = message.chat.id
    context = chat_contexts.get(chat_id)
    if not context:
        bot.reply_to(message, "–ü–æ–∫–∞ –Ω–µ—á–µ–≥–æ —Ä–µ–∑—é–º–∏—Ä–æ–≤–∞—Ç—å.")
        return

    recent_messages = list(context)[-200:]
    text_block = "\n".join(m["content"] for m in recent_messages
                           if m.get("role") == "user")

    if not text_block:
        bot.reply_to(message, "–ü–æ–∫–∞ –Ω–µ—á–µ–≥–æ —Ä–µ–∑—é–º–∏—Ä–æ–≤–∞—Ç—å.")
        return

    if len(text_block) > 8000:
        text_block = text_block[-8000:]

    summary_prompt = (
        "–¢—ã ‚Äî —Å–∞—Ä–∫–∞—Å—Ç–∏—á–Ω—ã–π, —è–∑–≤–∏—Ç–µ–ª—å–Ω—ã–π –±–æ—Ç-—Ñ–∏–ª–æ—Å–æ—Ñ –î–∂–∞–º—à—É—Ç. "
        "–í–æ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –≥—Ä—É–ø–ø–æ–≤–æ–≥–æ —á–∞—Ç–∞. "
        "–°–¥–µ–ª–∞–π –∫—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ —Ç–æ–≥–æ, –æ —á—ë–º —à–ª–∞ —Ä–µ—á—å, —Å –∏—Ä–æ–Ω–∏–µ–π –∏ —Ö–æ–ª–æ–¥–Ω—ã–º —é–º–æ—Ä–æ–º. "
        "–û—Ç–≤–µ—á–∞–π –Ω–µ –±–æ–ª–µ–µ 100 —Å–ª–æ–≤. –ù–µ —É–ø–æ–º–∏–Ω–∞–π –µ–Ω–æ—Ç–æ–≤, –Ω–µ –∑–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å–æ–≤.")

    try:
        summary = generate_response(summary_prompt + "\n\n" + text_block, [],
                                    user_id=None)
        bot.reply_to(message, f"üß† {summary}")
    except Exception:
        bot.reply_to(message, "–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫, –ø–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ.")
        print("‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ä–µ–∑—é–º–µ:", traceback.format_exc())


# === –ö–æ–º–∞–Ω–¥–∞ /–ø—Ä–æ—Ñ–∏–ª—å ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–∞—Ä–∫–∞—Å—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ===
@bot.message_handler(commands=["–ø—Ä–æ—Ñ–∏–ª—å", "profile"])
def show_profile(message):
    try:
        # 1) –ï—Å–ª–∏ –∫–æ–º–∞–Ω–¥–∞ ‚Äî –≤ –æ—Ç–≤–µ—Ç –Ω–∞ —á—å—ë-—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º replied user
        target_uid = None
        target_name = None

        if getattr(message, "reply_to_message", None):
            replied = message.reply_to_message.from_user
            if replied and getattr(replied, "id", None):
                target_uid = int(replied.id)
                target_name = (replied.first_name or "") + (
                    (" " + replied.last_name) if getattr(
                        replied, "last_name", None) else "")
                target_name = target_name.strip() or getattr(
                    replied, "username", None) or f"User_{target_uid}"

        # 2) –ï—Å–ª–∏ –∞—Ä–≥—É–º–µ–Ω—Ç –µ—Å—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä: /–ø—Ä–æ—Ñ–∏–ª—å @username –∏–ª–∏ /–ø—Ä–æ—Ñ–∏–ª—å 12345 –∏–ª–∏ /–ø—Ä–æ—Ñ–∏–ª—å t.me/username)
        if not target_uid:
            parts = message.text.split()
            if len(parts) > 1:
                arg = parts[1].strip()
                # —É–±–∏—Ä–∞–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ —Å–∫–æ–±–∫–∏/—Å–ª–µ—à–∏
                arg = arg.rstrip('/').lstrip()
                # –µ—Å–ª–∏ t.me —Å—Å—ã–ª–∫–∞
                if "t.me/" in arg:
                    arg = arg.split("t.me/")[-1].strip()
                # –µ—Å–ª–∏ @username
                if arg.startswith("@"):
                    name_to_find = arg.lstrip("@").lower()
                    with usernames_lock:
                        for uid, data in usernames_seen.items():
                            # data –º–æ–∂–µ—Ç –±—ã—Ç—å {"id":..., "name":...}
                            dname = (data.get("name") or "").lower()
                            if dname == name_to_find or (
                                    getattr(data, "get", None)
                                    and data.get("username",
                                                 "").lower() == name_to_find):
                                target_uid = int(uid)
                                target_name = data.get("name") or arg
                                break
                # –µ—Å–ª–∏ numeric id
                if not target_uid and re.fullmatch(r"\d{5,}", arg):
                    try:
                        candidate = int(arg)
                        target_uid = candidate
                        target_name = None
                    except Exception:
                        pass

        # 3) –ï—Å–ª–∏ –≤—Å—ë –µ—â—ë –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –≤—ã–∑—ã–≤–∞—é—â–µ–≥–æ
        if not target_uid:
            user = message.from_user
            target_uid = int(user.id)
            target_name = (user.first_name or "") + (
                (" " +
                 user.last_name) if getattr(user, "last_name", None) else "")
            target_name = target_name.strip() or getattr(
                user, "username", None) or f"User_{target_uid}"

        # –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –∏ –æ—Ç–≤–µ—á–∞–µ–º
        profile = get_user_profile_text(target_uid, target_name)
        bot.reply_to(message, profile)

    except Exception:
        bot.reply_to(message, "–ù–µ –º–æ–≥—É –ø–æ–∫–∞–∑–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å —Å–µ–π—á–∞—Å.")
        print("‚ö†Ô∏è –û—à–∏–±–∫–∞ –≤ /–ø—Ä–æ—Ñ–∏–ª—å:", traceback.format_exc())


# === –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–±–µ–∑ –∫–æ–º–∞–Ω–¥) ===
@bot.message_handler(
    func=lambda m: not (m.text and m.text.lstrip().startswith("/")),
    content_types=['text'])
def handle_message(message):
    if not message:
        return

    ADMIN_ID = int(os.getenv("ADMIN_ID", 0))
    CHANNEL_ID = int(os.getenv("CHANNEL_ID", 0))
    ALLOWED_CHAT_IDS = {CHANNEL_ID}

    # 0Ô∏è‚É£ ‚Äî –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ–ø—É—Å—Ç–∏–º–æ—Å—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫–∞
    if message.chat.type == "private" and message.from_user.id != ADMIN_ID:
        # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –ª–∏—á–∫—É —Å –¥—Ä—É–≥–∏–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
        return
    if message.chat.type in ["group", "supergroup"
                             ] and message.chat.id not in ALLOWED_CHAT_IDS:
        # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –≤—Å–µ –¥—Ä—É–≥–∏–µ –≥—Ä—É–ø–ø—ã
        return

    # 1Ô∏è‚É£ ‚Äî –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –∏ –Ω–µ –ø—É—Å—Ç–æ–µ
    if not getattr(message, "text", "").strip():
        return

    text = message.text.strip()
    text_lower = text.lower()

    # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —á–∏—Å—Ç—ã–µ —ç–º–æ–¥–∑–∏, —Å–º–∞–π–ª—ã –∏ —Å—Ç–∏–∫–µ—Ä—ã
    if not re.search(r"[a-zA-Z–∞-—è–ê-–Ø—ë–Å—ñ–Ü—ó–á—î–Ñ]", text):
        return

    # 2Ô∏è‚É£ ‚Äî –û—Ç–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    if abs(time.time() -
           getattr(message, "date", time.time())) > MESSAGE_TIME_WINDOW:
        return

    # 3Ô∏è‚É£ ‚Äî –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    try:
        user = message.from_user
        if user:
            name = user.first_name or getattr(user, "username",
                                              None) or "–¥—Ä—É–≥ –º–æ–π"
            if getattr(user, "last_name", None):
                name = f"{name} {user.last_name}"

            with usernames_lock:
                usernames_seen[int(user.id)] = {
                    "id":
                    int(user.id),
                    "name":
                    ((user.first_name or "") +
                     ((" " +
                       user.last_name) if user.last_name else "")).strip()
                    or (user.username or f"User_{user.id}")
                }

            update_user_memory(int(user.id), text, name)
    except Exception:
        print("‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ display name:", traceback.format_exc())

    chat_id = message.chat.id

    # 4Ô∏è‚É£ ‚Äî –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∑–∞–ø—Ä–æ—Å —Ä–µ–∑—é–º–µ ("–¥–∂–∞–º, –ø–æ–¥–≤–µ–¥–∏ –∏—Ç–æ–≥")
    summary_keywords = ("—Ä–µ–∑—é–º–µ", "–∏—Ç–æ–≥", "–æ–±–∑–æ—Ä", "—Å–≤–æ–¥–∫", "–ø–æ–¥–≤–µ–¥–∏",
                        "–∏–∑–ª–æ–∂–µ–Ω")

    if any(k in text_lower
           for k in summary_keywords) and is_mentioned(text_lower):
        if len(text_lower.split()) < 3:
            print(f"‚ö†Ô∏è –ò–≥–Ω–æ—Ä–∏—Ä—É—é –∫–æ—Ä–æ—Ç–∫–∏–π –∑–∞–ø—Ä–æ—Å —Ä–µ–∑—é–º–µ: {text_lower}")
            return

        try:
            match = re.search(
                r"\b(?:—Ä–µ–∑—é–º–µ|—Å–≤–æ–¥–∫|–∏—Ç–æ–≥|–æ–±–∑–æ—Ä|–ø–æ–¥–≤–µ–¥–∏(?:\s+–∏—Ç–æ–≥)?|–∏–∑–ª–æ–∂–µ–Ω)\b.*?(\d+)?",
                text_lower)

            num_messages = int(
                match.group(1)) if match and match.group(1) else 100
            num_messages = max(10, min(num_messages, 300))

            summary = summarize_dynamic(chat_id, num_messages)
            bot.reply_to(message,
                         f"üß† {summary or '–ü–æ–∫–∞ –Ω–µ—á–µ–≥–æ —Ä–µ–∑—é–º–∏—Ä–æ–≤–∞—Ç—å.'}")

        except Exception:
            bot.reply_to(message, "–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ä–µ–∑—é–º–µ.")
            print("‚ö†Ô∏è –û—à–∏–±–∫–∞ –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ä–µ–∑—é–º–µ:", traceback.format_exc())
        return

    # 5Ô∏è‚É£ ‚Äî –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    context = chat_contexts.setdefault(chat_id, deque(maxlen=200))
    context.append({"role": "user", "content": text})

    # 6Ô∏è‚É£ ‚Äî –õ–æ–≥–∏–∫–∞ –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏—è, –æ—Ç–≤–µ—á–∞—Ç—å –∏–ª–∏ –Ω–µ—Ç
    try:
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π username, –µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å
        BOT_USERNAME = BOT_USERNAME_GLOBAL
    except NameError:
        # –ë–µ–∑–æ–ø–∞—Å–Ω–æ –ø–æ–ª—É—á–∞–µ–º username –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ
        BOT_USERNAME = (getattr(bot.get_me(), "username", "") or "").lower()
        BOT_USERNAME_GLOBAL = BOT_USERNAME

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª –ª–∏ –æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç–∞
    reply_from = getattr(getattr(message, "reply_to_message", None),
                         "from_user", None)
    reply_to_bot = (reply_from and (getattr(reply_from, "username", "")
                                    or "").lower() == BOT_USERNAME)

    should_reply = (is_mentioned(text_lower) or reply_to_bot
                    or (message.chat.type == "private"
                        and message.from_user.id == ADMIN_ID)
                    or (message.chat.type in ["group", "supergroup"]
                        and random.random() < 0.01))

    if not should_reply:
        return

    # 7Ô∏è‚É£ ‚Äî –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–∞
    try:
        uid = int(message.from_user.id)
        uname = (((message.from_user.first_name or "") +
                  ((" " + message.from_user.last_name)
                   if message.from_user.last_name else "")).strip()
                 or getattr(message.from_user, "username", None)
                 or f"User_{uid}")

        context_list = list(context)
        if not context_list:
            context_list = [{"role": "system", "content": "–ù–∞—á–∞–ª–æ –¥–∏–∞–ª–æ–≥–∞."}]

        response = generate_response(text,
                                     context_list,
                                     user_id=uid,
                                     username=uname)
        styled_response = response

        bot.reply_to(message, styled_response)
        context.append({"role": "assistant", "content": styled_response})

    except Exception:
        bot.reply_to(message, "–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫, –ø–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ.")
        print("‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞:", traceback.format_exc())

    # === –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–æ—Å—Ç–æ—è–Ω–∏—è polling ===
    bot_alive = True


def monitor_bot():
    global bot_alive
    was_alive = True
    while True:
        time.sleep(30)
        if not bot_alive and was_alive:
            was_alive = False
            if ADMIN_ID:
                try:
                    bot.send_message(
                        ADMIN_ID,
                        "‚ö†Ô∏è Polling –æ—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è. –ë–æ—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç.")
                except Exception:
                    print("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —É–≤–µ–¥–æ–º–∏—Ç—å –∞–¥–º–∏–Ω–∞ –æ –ø–∞–¥–µ–Ω–∏–∏.")
        elif bot_alive and not was_alive:
            was_alive = True
            if ADMIN_ID:
                try:
                    bot.send_message(ADMIN_ID, "‚úÖ Polling –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.")
                except Exception:
                    print("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —É–≤–µ–¥–æ–º–∏—Ç—å –∞–¥–º–∏–Ω–∞ –æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏.")


threading.Thread(target=monitor_bot, daemon=True).start()


# === –§–µ–π–∫–æ–≤—ã–π HTTP —Å–µ—Ä–≤–µ—Ä (–¥–ª—è Render/Replit) ===
class PingHandler(BaseHTTPRequestHandler):

    def do_GET(self):
        self.send_response(200)
        self.send_header("Content-type", "text/plain; charset=utf-8")
        self.end_headers()
        self.wfile.write(b"Bot is alive")


def run_server():
    port = int(os.environ.get("PORT", "10000"))
    server = HTTPServer(("0.0.0.0", port), PingHandler)
    print(f"üåç Web server running on port {port}")
    server.serve_forever()


threading.Thread(target=run_server, daemon=True).start()


def self_ping():
    """
    –ê–≤—Ç–æ–ø–∏–Ω–≥ —Å–≤–æ–µ–≥–æ –∂–µ HTTP-—Å–µ—Ä–≤–∏—Å–∞ –∫–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç,
    —á—Ç–æ–±—ã Render –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª —Å–µ—Ä–≤–∏—Å –≤ —Å–ø—è—â–∏–π —Ä–µ–∂–∏–º.
    """
    url = os.environ.get(
        "SELF_URL"
    )  # –í .env –∏–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö Render: https://telegramopenai.onrender.com
    if not url:
        print("‚ö†Ô∏è SELF_URL –Ω–µ –∑–∞–¥–∞–Ω, –∞–≤—Ç–æ–ø–∏–Ω–≥ –Ω–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å")
        return

    while True:
        try:
            response = requests.get(url, timeout=5)
            print(f"üü¢ Ping successful: {response.status_code}")
        except Exception as e:
            print(f"üî¥ Ping failed: {e}")
        time.sleep(600)  # 600 —Å–µ–∫—É–Ω–¥ = 10 –º–∏–Ω—É—Ç


# –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–ø–∏–Ω–≥–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
threading.Thread(target=self_ping, daemon=True).start()


# === –•–µ–Ω–¥–ª–µ—Ä—ã –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è ===
def handle_shutdown(signum, frame):
    try:
        if ADMIN_ID:
            bot.send_message(ADMIN_ID,
                             "‚ö†Ô∏è –ë–æ—Ç –î–∂–∞–º—à—É—Ç –±—ã–ª –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤—Ä—É—á–Ω—É—é.")
    except Exception:
        pass
    save_contexts()
    save_usernames()
    save_user_memory()
    sys.exit(0)


signal.signal(signal.SIGINT, handle_shutdown)
signal.signal(signal.SIGTERM, handle_shutdown)

# === –ì–ª–∞–≤–Ω—ã–π —Ü–∏–∫–ª polling —Å –∞–≤—Ç–æ-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏ –∞–¥–º–∏–Ω–∞ –æ –∑–∞–ø—É—Å–∫–µ/–ø–∞–¥–µ ===
while True:
    try:
        bot_alive = True
        if ADMIN_ID:
            try:
                bot.send_message(
                    ADMIN_ID, "‚úÖ –ë–æ—Ç –î–∂–∞–º—à—É—Ç –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ —Ñ–∏–ª–æ—Å–æ—Ñ—Å—Ç–≤–æ–≤–∞—Ç—å.")
            except Exception:
                pass
        bot.polling(none_stop=True, interval=0, timeout=60)
    except Exception as e:
        bot_alive = False
        print("‚ö†Ô∏è –û—à–∏–±–∫–∞ polling:", e)
        if ADMIN_ID:
            try:
                bot.send_message(ADMIN_ID, f"‚ùå –ë–æ—Ç —É–ø–∞–ª —Å –æ—à–∏–±–∫–æ–π:\n{e}")
            except Exception:
                pass
        time.sleep(5)
